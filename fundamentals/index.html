<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Fundamentals</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Fundamentals" /> <meta name="author" content="Kayvan Kazeminejad" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Tutorial a new Napkin user with examples showing all features and use-cases." /> <meta property="og:description" content="Tutorial a new Napkin user with examples showing all features and use-cases." /> <link rel="canonical" href="https://soostone.github.io/fundamentals/" /> <meta property="og:url" content="https://soostone.github.io/fundamentals/" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Fundamentals" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Kayvan Kazeminejad"},"url":"https://soostone.github.io/fundamentals/","@type":"WebPage","description":"Tutorial a new Napkin user with examples showing all features and use-cases.","headline":"Fundamentals","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/js/resize.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting started</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/install/" class="nav-list-link">Installation</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/install#native" class="nav-list-link">Native</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#homebrew" class="nav-list-link">Homebrew</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#cachix" class="nav-list-link">Cachix</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link">Tutorial</a></li>
<li class="nav-list-item active"><a href="https://soostone.github.io/fundamentals/" class="nav-list-link active">Fundamentals</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link">Tips and Tricks</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/spec-arguments" class="nav-list-link">Spec arguments</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/yaml-reference" class="nav-list-link">Spec YAML reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection" class="nav-list-link">Connecting to the database</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/cli-reference" class="nav-list-link">CLI reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/multi-environment" class="nav-list-link">Multi-environment pipelines in a team setting</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/mustache" class="nav-list-link">Mustache Interpolation</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/devcontainer" class="nav-list-link">Devcontainer</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/preprocessors" class="nav-list-link">Preprocessors</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/github-actions" class="nav-list-link">Running as a scheduled job on GitHub Actions</a></li>
</ul>
</li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/metaprogramming" class="nav-list-link">Metaprogramming</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/repl" class="nav-list-link">REPL</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/custom-hooks" class="nav-list-link">Writing Custom Hooks</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/haskell" class="nav-list-link">Haskell API</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">API Reference</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/changelog/" class="nav-list-link">Changelog</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/ide" class="nav-list-link">IDE Support</a></li>
</ul> </nav> </div> <div class="site-super-header"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <a class="link-button active" href="/">Documentation</a> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> <span class="gradient-border"> <a class="link-button" href="/install/">Install</a> </span> </div> </div> </div> <div class="width-ruler"></div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <ul id="markdown-toc"> <li>
<a href="#napkin-fundamentals-tutorial" id="markdown-toc-napkin-fundamentals-tutorial">Napkin fundamentals tutorial</a> <ul> <li><a href="#getting-started" id="markdown-toc-getting-started">Getting started</a></li> <li><a href="#get-example-dataset" id="markdown-toc-get-example-dataset">Get example dataset</a></li> <li><a href="#bootstrapping-napkin" id="markdown-toc-bootstrapping-napkin">Bootstrapping napkin</a></li> <li><a href="#setting-db-connection" id="markdown-toc-setting-db-connection">Setting DB connection</a></li> <li><a href="#the-first-queries" id="markdown-toc-the-first-queries">The first queries</a></li> <li><a href="#best-markets" id="markdown-toc-best-markets">Best markets</a></li> <li><a href="#discovering-dependencies" id="markdown-toc-discovering-dependencies">Discovering dependencies</a></li> <li><a href="#dry-dont-repeat-yourself" id="markdown-toc-dry-dont-repeat-yourself">DRY: Don’t Repeat Yourself</a></li> <li><a href="#garbage-in-garbage-out-validating-data" id="markdown-toc-garbage-in-garbage-out-validating-data">Garbage in, garbage out: validating data</a></li> <li><a href="#napkin-remembers" id="markdown-toc-napkin-remembers">Napkin remembers</a></li> <li><a href="#saving-our-work" id="markdown-toc-saving-our-work">Saving our work</a></li> <li><a href="#changing-napkin-backend-optional" id="markdown-toc-changing-napkin-backend-optional">Changing Napkin backend (Optional)</a></li> <li><a href="#summary" id="markdown-toc-summary">Summary</a></li> </ul> </li> </ul> <h1 id="napkin-fundamentals-tutorial">Napkin fundamentals tutorial</h1> <p>This is the first of a series of tutorials to get up and running with Napkin development. We do this through the example of building a simple Napkin data pipeline. The goal is that by the end of this tutorial, you’ll have a good idea of:</p> <ul> <li>How to start a Napkin project</li> <li>How to modify, verify, and execute Napkin projects</li> <li>How to automatically test data</li> <li>How Napkin helps you build a real-life application quickly</li> </ul> <p>With that, let’s get started!</p> <h2 id="getting-started">Getting started</h2> <p>There are a few preliminaries for this tutorial: we assume you’re running Linux or macOS. You need to install <a href="/install/">Napkin</a>. If you are running Linux, you also need to install <a href="https://www.sqlite.org/index.html" target="_blank" rel="noopener noreferrer">SQLite</a> for this tutorial. Windows users can use <a href="/user-manual/docker">Docker</a> or <a href="/user-manual/devcontainer">Devcontainer</a> setup that will bring all necessary tools.</p> <p>With the preliminaries out of the way, we are ready to proceed with bootstrapping our first Napkin data pipeline.</p> <h2 id="get-example-dataset">Get example dataset</h2> <p>In this tutorial we will use <a href="https://github.com/lerocha/chinook-database" target="_blank" rel="noopener noreferrer">Chinook</a> database that is commonly used as an example dataset. Chinook database represents a digital media store database with tables for artists, albums, media tracks, invoices and customers. For sake of simplicity, we will use <a href="https://www.sqlite.org/index.html" target="_blank" rel="noopener noreferrer">SQLite</a> backend, so no additional setup for database is required. In production-grade environment, one can use any of supported backends, such as Postgres or BigQuery. We will demonstrate Napkin’s features with simple queries to give the reader the sense of benefits of using Napkin for more complex data pipelines.</p> <p>Let’s download database file from GitHub with the following command.</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-o</span> chinook-sql.db https://github.com/lerocha/chinook-database/raw/master/ChinookDatabase/DataSources/Chinook_Sqlite.sqlite
</code></pre></div></div> <p>To verify the Chinook database and SQLite work correctly run:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 chinook-sql.db <span class="s2">"SELECT * FROM Artist"</span>
</code></pre></div></div> <h2 id="bootstrapping-napkin">Bootstrapping napkin</h2> <p>The most intuitive way of initiating a Napkin project is to use the <code class="language-plaintext highlighter-rouge">init</code> CLI command. <code class="language-plaintext highlighter-rouge">napkin init</code> creates a new project skeleton with Napkin’s default template.</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>napkinFundamentalTutorial
<span class="nb">cd </span>napkinFundamentalTutorial
napkin init <span class="nt">--project-name</span> chinook-analytic
</code></pre></div></div> <p>The corresponding directory structure created by Napkin’s <code class="language-plaintext highlighter-rouge">init</code> command for the <code class="language-plaintext highlighter-rouge">chinook-analytic</code> project is:</p> <p class="text-delta text-center">shell</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chinook-analytic
├── hie.yaml
├── README.md
├── specs
│   └── spec.yaml
└── sql
    └── example.sql
</code></pre></div></div> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>Napkin’s CLI is the point of entry for all typical workflows of data engineering and pipeline curation. <code class="language-plaintext highlighter-rouge">napkin --help</code> provides a comprehensive list of available Napkin commands. Commands may take additional parameters. To get help with these parameters, use: <code class="language-plaintext highlighter-rouge">napkin command --help</code>. For instance to get help with the <code class="language-plaintext highlighter-rouge">init</code> command, use <code class="language-plaintext highlighter-rouge">napkin init --help</code>.</p> </div> </div> <p>The data pipeline we will be working on is specified in <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code> file, let’s explore how it looks like:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># yaml-language-server: $schema=http://soostone-napkin-public.s3-website.us-east-1.amazonaws.com/schema/schema.json</span>

<span class="c1"># Connect to database:</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Postgres</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">postgresql://user@host/database</span>
<span class="c1"># set your password by providing it using --uri or set PGPASSWORD variable</span>

<span class="c1"># backend: BigQuery</span>
<span class="c1"># db_url: bigquery://bigquery.googleapis.com/project_name?dataset=default_dataset_name</span>
<span class="c1"># Run `napkin auth` to obtain authentication token</span>

<span class="na">tables</span><span class="pi">:</span>
  <span class="na">example</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">example.sql</span>
</code></pre></div></div> <p>First, we enable YAML IDE support, then we choose backend and provide DB connection details, finally we’ll replace the <code class="language-plaintext highlighter-rouge">example</code> Napkin managed table.</p> <p>Before moving to the next section, let’s validate our project using Napkin’s <code class="language-plaintext highlighter-rouge">validate</code> command:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin validate
</code></pre></div></div> <p>Let’s keep validating our spec as we move through the tutorial. You can also conveniently run validation in interactive mode, so Napkin will revalidate spec whenever the Spec file or queries are changed.</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin validate <span class="nt">--interactive</span>
</code></pre></div></div> <p>By default, Napkin will use <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code> relative to the current directory for all commands. You can explicitly select the spec with <code class="language-plaintext highlighter-rouge">--spec-file</code> argument.</p> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>Napkin follows a common paradigm where source tables are not mutated by Napkin. Instead, Napkin creates a series of dependent tables, <strong>managed</strong> tables, based on the SQL files in <code class="language-plaintext highlighter-rouge">sql/</code> folder. Internally, Napkin uses <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code> to create a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph" target="_blank" rel="noopener noreferrer">DAG</a> that describes data dependencies between managed and unmanaged tables. Napkin uses this DAG to drive the execution plan. In addition to DAG, Napkin <strong>Spec</strong> contains back-end connection related data for connecting to supported target databases.</p> </div> </div> <h2 id="setting-db-connection">Setting DB connection</h2> <p>Before we can do any operations on the database, we need to configure the database connection. In our case, we need to point napkin to the SQLite file. We can do this by replacing <code class="language-plaintext highlighter-rouge">backend</code> and <code class="language-plaintext highlighter-rouge">db_uri</code> in <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code> file.</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Connect to Sqlite database:</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:chinook-sql.db</span>
</code></pre></div></div> <p>Let’s also remove the definition of the <code class="language-plaintext highlighter-rouge">example</code> table from our Spec, as well as <code class="language-plaintext highlighter-rouge">sql/example.sql</code> it references, as we no longer need them. Now, we can proceed with running our queries.</p> <h2 id="the-first-queries">The first queries</h2> <p>Let’s start exploring our data set and calculate a summary of sales in each country. First, we need to create a SQL query and store it in <code class="language-plaintext highlighter-rouge">sql/sales_by_country.sql</code> file.</p> <p class="text-delta text-center">sql/sales_by_country.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="nv">"BillingCountry"</span> <span class="k">AS</span> <span class="nv">"Country"</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="nv">"Total"</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"Sales"</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"NumInvoices"</span>
<span class="k">FROM</span>
    <span class="nv">"Invoice"</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="nv">"BillingCountry"</span>
</code></pre></div></div> <p>Now we need to link our SQL file to the <code class="language-plaintext highlighter-rouge">sales_by_country</code> table we’d like to create.</p> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>By convention, Napkin will load SQL files from <code class="language-plaintext highlighter-rouge">../sql</code> relative to the Spec file. This can be overridden with <code class="language-plaintext highlighter-rouge">sql_dir: some_other_dir</code> in the Spec file.</p> </div> </div> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="na">sales_by_country</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">sales_by_country.sql</span>
</code></pre></div></div> <p>Let’s validate the spec again with <code class="language-plaintext highlighter-rouge">napkin validate</code>, and then we will be ready to run it for the first time:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Determining</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">update</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Forced</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Skipped</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Unmanaged</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span> 
<span class="o">-</span> <span class="nc">Invoice</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="nl">updated:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">updated</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span> 
<span class="o">-</span> <span class="n">sales_by_country</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Estimated</span> <span class="nl">runtime:</span> <span class="mi">0</span><span class="n">s</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"sales_by_country"</span> <span class="n">server</span> <span class="nl">stats:</span> 
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"sales_by_country"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.02</span><span class="o">:</span> 
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">28</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Run</span> <span class="n">complete</span><span class="o">.</span> <span class="nc">Total</span> <span class="nl">cost:</span> 
</code></pre></div></div> <p>Now the <code class="language-plaintext highlighter-rouge">sales_by_country</code> should exist in the database. Let’s double-check:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 chinook-sql.db <span class="s2">"SELECT * FROM sales_by_country"</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Argentina</span><span class="o">|</span><span class="mi">37</span><span class="p">.</span><span class="mi">62</span><span class="o">|</span><span class="mi">7</span>
<span class="n">Australia</span><span class="o">|</span><span class="mi">37</span><span class="p">.</span><span class="mi">62</span><span class="o">|</span><span class="mi">7</span>
<span class="n">Austria</span><span class="o">|</span><span class="mi">42</span><span class="p">.</span><span class="mi">62</span><span class="o">|</span><span class="mi">7</span>
<span class="n">Belgium</span><span class="o">|</span><span class="mi">37</span><span class="p">.</span><span class="mi">62</span><span class="o">|</span><span class="mi">7</span>
<span class="p">...</span>
</code></pre></div></div> <h2 id="best-markets">Best markets</h2> <p>We have decided to perform more detailed analysis for ten countries with top sales. We expect to reuse that list over and over again, but also we would like to do this following the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener noreferrer">DRY</a> principle. Since we have already calculated country sales, we can use <code class="language-plaintext highlighter-rouge">sales_by_country</code> table as an input. Let’s add <code class="language-plaintext highlighter-rouge">top_10_countries</code> table to our Spec:</p> <p class="text-delta text-center">sql/top_10_countries.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">sales_by_country</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="nv">"Sales"</span> <span class="k">DESC</span>
<span class="k">FETCH</span> <span class="k">FIRST</span> <span class="mi">10</span> <span class="k">ROWS</span> <span class="k">ONLY</span>
</code></pre></div></div> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">top_10_countries</span><span class="err">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_10_countries.sql</span>
</code></pre></div></div> <p>Next, we would like to know the number of customers in our top countries. Let’s add this to spec as well:</p> <p class="text-delta text-center">sql/top_10_countries_customers.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">top_10_countries</span><span class="p">.</span><span class="nv">"Country"</span> <span class="k">AS</span> <span class="nv">"Country"</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"NumCustomers"</span>
<span class="k">FROM</span>
    <span class="n">top_10_countries</span>
    <span class="k">JOIN</span>
    <span class="nv">"Customer"</span> <span class="k">ON</span> <span class="n">top_10_countries</span><span class="p">.</span><span class="nv">"Country"</span> <span class="o">=</span> <span class="nv">"Customer"</span><span class="p">.</span><span class="nv">"Country"</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">top_10_countries</span><span class="p">.</span><span class="nv">"Country"</span>
</code></pre></div></div> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">top_10_countries_customers</span><span class="err">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_10_countries_customers.sql</span>
</code></pre></div></div> <p>Let’s run the spec again and check if it’s all correct:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 chinook-sql.db <span class="s2">"SELECT * FROM toGp_10_countries_customers"</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Brazil</span><span class="o">|</span><span class="mi">5</span>
<span class="n">Canada</span><span class="o">|</span><span class="mi">8</span>
<span class="n">Chile</span><span class="o">|</span><span class="mi">1</span>
<span class="n">Czech</span> <span class="n">Republic</span><span class="o">|</span><span class="mi">2</span>
<span class="n">France</span><span class="o">|</span><span class="mi">5</span>
<span class="n">Germany</span><span class="o">|</span><span class="mi">4</span>
<span class="n">India</span><span class="o">|</span><span class="mi">2</span>
<span class="n">Portugal</span><span class="o">|</span><span class="mi">2</span>
<span class="n">USA</span><span class="o">|</span><span class="mi">13</span>
<span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span><span class="mi">3</span>
</code></pre></div></div> <h2 id="discovering-dependencies">Discovering dependencies</h2> <p>We have added three tables so far to the Spec and successfully ran them. Napkin did some heavy lifting for us – it analyzed all queries, figured out dependencies and executed the queries in the correct order. Let’s explore this with <code class="language-plaintext highlighter-rouge">dump</code> command which will store all queries (after being processed by napkin), as well as dependency graph into <code class="language-plaintext highlighter-rouge">dump/</code> folder:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin dump
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dump
├── 1_sales_by_country.sql
├── 2_top_10_countries.sql
├── 3_top_10_countries_customers.sql
├── dependency_graph.dot
├── dependency_graph.pdf
└── MANIFEST.txt
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">dependency_graph.pdf</code> file shows what dependencies have been discovered by Napkin. Note that <code class="language-plaintext highlighter-rouge">Invoice</code> and <code class="language-plaintext highlighter-rouge">Customer</code> tables are displayed differently, as they are unmanaged tables.</p> <p><img src="/fundamentals/dag.svg" alt="DAG generated by Napkin"></p> <h2 id="dry-dont-repeat-yourself">DRY: Don’t Repeat Yourself</h2> <p>Let’s explore our customers. Let’s first aggregate total sales per customer:</p> <p class="text-delta text-center">sql/customers_total_purchase.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">Customer</span><span class="p">.</span><span class="n">CustomerId</span> <span class="k">AS</span> <span class="nv">"CustomerId"</span><span class="p">,</span>
    <span class="n">Customer</span><span class="p">.</span><span class="n">Email</span> <span class="k">AS</span> <span class="nv">"Email"</span><span class="p">,</span>
    <span class="n">Customer</span><span class="p">.</span><span class="n">FirstName</span> <span class="k">AS</span> <span class="nv">"FirstName"</span><span class="p">,</span>
    <span class="n">Customer</span><span class="p">.</span><span class="n">LastName</span> <span class="k">AS</span> <span class="nv">"LastName"</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">Invoice</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"CustomerSales"</span>
<span class="k">FROM</span>
    <span class="n">Customer</span> 
    <span class="k">JOIN</span> <span class="n">Invoice</span>  <span class="k">ON</span> <span class="n">Customer</span><span class="p">.</span><span class="n">CustomerId</span> <span class="o">=</span> <span class="n">Invoice</span><span class="p">.</span><span class="n">CustomerId</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">Customer</span><span class="p">.</span><span class="n">CustomerId</span>
</code></pre></div></div> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">customers_total_purchase</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">customers_total_purchase.sql</span>
</code></pre></div></div> <p>Next, we’d like to find out our top 20 customers:</p> <p class="text-delta text-center">sql/top_20_customers.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">customers_total_purchase</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="nv">"CustomerSales"</span> <span class="k">DESC</span>
<span class="k">FETCH</span> <span class="k">FIRST</span> <span class="mi">20</span> <span class="k">ROWS</span> <span class="k">ONLY</span>
</code></pre></div></div> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">top_20_customers</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_20_customers.sql</span>
</code></pre></div></div> <p>Doesn’t that look familiar? Can we do better? The answer is: yes! Let’s start with creating our template query in <code class="language-plaintext highlighter-rouge">sql/top_performers.sql</code> file with some placeholders:</p> <p class="text-delta text-center">sql/top_performers.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span>
    <span class="nv">"{{table}}"</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="nv">"{{top_by}}"</span> <span class="k">DESC</span>
<span class="k">FETCH</span> <span class="k">FIRST</span> <span class="err">{{</span><span class="n">max_limit</span><span class="err">}}</span> <span class="k">ROWS</span> <span class="k">ONLY</span>
</code></pre></div></div> <p>How do we use it? Let’s refactor our table definitions:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">top_10_countries</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_performers.sql</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">sales_by_country</span>
          <span class="na">max_limit</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">top_by</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Sales"</span>
  <span class="c1"># ...</span>
  <span class="na">top_20_customers</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_performers.sql</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">customers_total_purchase</span>
          <span class="na">max_limit</span><span class="pi">:</span> <span class="m">20</span>
          <span class="na">top_by</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CustomerSales"</span>
</code></pre></div></div> <p>Napkin uses <a href="https://mustache.github.io" target="_blank" rel="noopener noreferrer">Mustache</a> template language to substitute variables specified in double curly braces with values provided in Spec file. This enables to reuse queries and keep the configuration in the Spec.</p> <p>We can now run our spec again and all new tables will be created for us. If we <code class="language-plaintext highlighter-rouge">dump</code> again, dependency graph will be updated:</p> <p><img src="/fundamentals/dag2.svg" alt="DAG generated by Napkin"></p> <h2 id="garbage-in-garbage-out-validating-data">Garbage in, garbage out: validating data</h2> <p>So far, we were able to verify if the results look good manually. However, as the spec grows and the source data is constantly updated by upstream services, it becomes a tedious job. We would better like to automate this process to some extent. Napkin provides a way to run assertions on input data and results of each table. Let’s invent a few invariants we expect from the data we have computed:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">sales_by_country</code>: <ul> <li>
<code class="language-plaintext highlighter-rouge">Country</code> column should be unique,</li> <li>should have more than 20 rows;</li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">top_10_countries</code>: <ul> <li>
<code class="language-plaintext highlighter-rouge">Country</code> column should be unique,</li> <li>should have exactly 10 rows;</li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">top_10_countries_customers</code>: <ul> <li>
<code class="language-plaintext highlighter-rouge">Country</code> column should be unique,</li> <li>should have exactly 10 rows,</li> <li>
<code class="language-plaintext highlighter-rouge">NumCustomers</code> column should have all values greater than zero;</li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">customers_total_purchase</code>: <ul> <li>
<code class="language-plaintext highlighter-rouge">CustomerSales</code> column should have all values greater than zero,</li> <li>
<code class="language-plaintext highlighter-rouge">CustomerId</code> column should be unique;</li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">top_20_customers</code>: <ul> <li>should have exactly 20 rows,</li> <li>
<code class="language-plaintext highlighter-rouge">CustomerId</code> column should be unique.</li> </ul> </li> </ul> <p>Let’s start with checks for <code class="language-plaintext highlighter-rouge">sales_by_country</code> table, we will use <code class="language-plaintext highlighter-rouge">assert_unique</code> and <code class="language-plaintext highlighter-rouge">assert_count</code> assertions. Please refer to <a href="/user-manual/">User Manual</a> for reference on other hooks.</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">sales_by_country</span><span class="pi">:</span>
    <span class="c1"># create_action: ...</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">sales_by_country</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Country"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_count</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">sales_by_country</span>
          <span class="na">greater_than</span><span class="pi">:</span> <span class="m">20</span>
</code></pre></div></div> <p>The invariant on <code class="language-plaintext highlighter-rouge">customers_total_purchase</code> that <code class="language-plaintext highlighter-rouge">NumCustomers</code> column has all values greater than zero is equivalent to requirement that minimum of that column is also greater than zero, and can be implemented with <code class="language-plaintext highlighter-rouge">assert_expression</code> hook:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">customers_total_purchase</span><span class="pi">:</span>
    <span class="c1"># create_action: ...</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="c1"># ...</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">customers_total_purchase</span>
          <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("CustomerSales") &gt; </span><span class="m">0</span>
</code></pre></div></div> <p>We can also check invariants on input tables. We recommend using <code class="language-plaintext highlighter-rouge">pre_hooks</code> instead, as they will run prior the table execution. For example, we may expect that all invoices have non-negative total:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tables</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">sales_by_country</span><span class="pi">:</span>
    <span class="c1"># create_action: ...</span>
    <span class="c1"># post_hooks: ...</span>
    <span class="na">pre_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Invoice"</span>
          <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("Total") &gt;= </span><span class="m">0</span>
</code></pre></div></div> <p>After all checks have been implemented, our spec should look like this:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># yaml-language-server: $schema=http://soostone-napkin-public.s3-website.us-east-1.amazonaws.com/schema/schema.json</span>

<span class="c1"># Connect to database:</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:chinook-sql.db</span>

<span class="na">tables</span><span class="pi">:</span>
  <span class="na">sales_by_country</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">sales_by_country.sql</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">sales_by_country</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Country"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_count</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sales_by_country"</span>
          <span class="na">greater_than</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">pre_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Invoice"</span>
          <span class="na">expression</span><span class="pi">:</span> 
            <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("Total") &gt;=0</span>

  <span class="na">top_10_countries</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_performers.sql</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">sales_by_country</span>
          <span class="na">max_limit</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">top_by</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Sales"</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_10_countries</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Country"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_count</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_10_countries</span>
          <span class="na">equal</span><span class="pi">:</span> <span class="m">10</span>

  <span class="na">top_10_countries_customers</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_10_countries_customers.sql</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_10_countries_customers</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Country"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_count</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_10_countries_customers</span>
          <span class="na">equal</span><span class="pi">:</span> <span class="m">10</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_10_countries_customers</span>
          <span class="na">expression</span><span class="pi">:</span>
            <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("NumCustomers") &gt; </span><span class="m">0</span>

  <span class="na">customers_total_purchase</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">customers_total_purchase.sql</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">customers_total_purchase</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CustomerId"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">customers_total_purchase</span>
          <span class="na">expression</span><span class="pi">:</span>
            <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("CustomerSales") &gt;= </span><span class="m">0</span>

  <span class="na">top_20_customers</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">top_performers.sql</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">customers_total_purchase</span>
          <span class="na">max_limit</span><span class="pi">:</span> <span class="m">20</span>
          <span class="na">top_by</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CustomerSales"</span>
    <span class="na">post_hooks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assert_unique</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_20_customers</span>
          <span class="na">columns</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CustomerId"</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">assert_count</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_20_customers</span>
          <span class="na">equal</span><span class="pi">:</span> <span class="m">20</span>
      <span class="pi">-</span> <span class="na">assert_expression</span><span class="pi">:</span>
          <span class="na">table</span><span class="pi">:</span> <span class="s">top_20_customers</span>
          <span class="na">expression</span><span class="pi">:</span>
            <span class="na">expression</span><span class="pi">:</span> <span class="s">MIN("CustomerSales") &gt; </span><span class="m">0</span>

</code></pre></div></div> <p>When we run our spec, Napkin will report status of all checks. By default, when any will fail, the spec execution will be aborted. We can make assertion to result in warning only by adding <code class="language-plaintext highlighter-rouge">on_failure: warn_only</code> attribute.</p> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"customers_total_purchase"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.15</span><span class="o">:</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">customers_total_purchase</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">customers_total_purchase:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">customers_total_purchase</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">customers_total_purchase:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"sales_by_country"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.19</span><span class="o">:</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Pre</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">Invoice:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">sales_by_country:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"sales_by_country"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">greater</span> <span class="n">than</span> <span class="mi">20</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_10_countries"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.16</span><span class="o">:</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_10_countries:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_10_countries"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">10</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_10_countries_customers"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.09</span><span class="o">:</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_10_countries_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_10_countries_customers"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">10</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">top_10_countries_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_20_customers"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.13</span><span class="o">:</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_20_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_20_customers"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">20</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mi">44</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">top_20_customers:</span> <span class="no">OK</span>
</code></pre></div></div> <h2 id="napkin-remembers">Napkin remembers</h2> <p>Napkin internally keeps track of your application state. You might find it helpful to spend some time with:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin <span class="nb">history </span>list <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <p>As always, <code class="language-plaintext highlighter-rouge">napkin history --help</code> will provide a comprehensive list of <em>history parameters</em></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      top_by: Invoices
</code></pre></div></div> <h2 id="saving-our-work">Saving our work</h2> <p>In addition to bootstrapping our project, the <code class="language-plaintext highlighter-rouge">init</code> command initialized an empty <a href="https://git-scm.com/" target="_blank" rel="noopener noreferrer">Git</a> repository that we may use to add or push or code to a remote Git repository.</p> <h2 id="changing-napkin-backend-optional">Changing Napkin backend (Optional)</h2> <p>For sake of simplicity, we started the tutorial with SQLite backend. In this optional section, we’ll change the backend from SQLite to <a href="http://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL</a> thru a few minor changes to the Napkin high-level API, Spec. Required steps are:</p> <ul> <li>get example dataset for PostgreSQL</li> </ul> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-O</span>   https://github.com/lerocha/chinook-database/raw/master/ChinookDatabase/DataSources/Chinook_PostgreSql.sql
psql <span class="nt">-f</span> Chinook_PostgreSql.sql 
</code></pre></div></div> <ul> <li>modify the <code class="language-plaintext highlighter-rouge">backend</code> and <code class="language-plaintext highlighter-rouge">db_url</code> of the <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code> and save as <code class="language-plaintext highlighter-rouge">specs/spec-postgres.yaml</code>
</li> </ul> <p class="text-delta text-center">specs/spec-postgres.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Connect to database:</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Postgres</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">postgresql://</span>
<span class="nn">...</span>
</code></pre></div></div> <ul> <li>execute the pipeline:</li> </ul> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec-postgres.yaml
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Determining</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">update</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Forced</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Skipped</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Unmanaged</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span> 
<span class="o">-</span> <span class="nc">Customer</span>
<span class="o">-</span> <span class="nc">Invoice</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="nl">updated:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">updated</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span> 
<span class="o">-</span> <span class="n">customers_total_purchase</span>
<span class="o">-</span> <span class="n">sales_by_country</span>
<span class="o">-</span> <span class="n">top_10_countries</span>
<span class="o">-</span> <span class="n">top_10_countries_customers</span>
<span class="o">-</span> <span class="n">top_20_customers</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Estimated</span> <span class="nl">runtime:</span> <span class="mf">0.333333333333</span><span class="n">s</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"customers_total_purchase"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="mi">36</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"sales_by_country"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="mi">11</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"top_10_countries"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="mi">10</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"top_20_customers"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="mi">20</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span><span class="n">s</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span><span class="err">'</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"top_10_countries_customers"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="mi">10</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"customers_total_purchase"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.02</span><span class="o">:</span> <span class="mi">36</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">customers_total_purchase</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">customers_total_purchase:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">customers_total_purchase</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">customers_total_purchase:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"sales_by_country"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.01</span><span class="o">:</span> <span class="mi">11</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Pre</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">Invoice:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">sales_by_country:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">sales_by_country</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"sales_by_country"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">greater</span> <span class="n">than</span> <span class="mi">10</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_10_countries"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.01</span><span class="o">:</span> <span class="mi">10</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_10_countries:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_10_countries"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">10</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_10_countries_customers"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.01</span><span class="o">:</span> <span class="mi">10</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_10_countries_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_10_countries_customers"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">10</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_10_countries_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">top_10_countries_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"top_20_customers"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.01</span><span class="o">:</span> <span class="mi">20</span> <span class="n">rows</span> <span class="n">affected</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">/</span> <span class="nl">assertUniqueBy:</span> <span class="nl">top_20_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="nl">assertCountConst:</span> <span class="n">row</span> <span class="n">count</span> <span class="n">of</span> <span class="s">"top_20_customers"</span> <span class="n">should</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span> <span class="mi">20</span><span class="o">:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Assertion</span> <span class="n">top_20_customers</span> <span class="o">/</span> <span class="nc">Post</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="nl">assertExpression:</span> <span class="nl">top_20_customers:</span> <span class="no">OK</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">40</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Run</span> <span class="n">complete</span><span class="o">.</span> <span class="nc">Total</span> <span class="nl">cost:</span> <span class="mi">87</span> <span class="n">rows</span> <span class="n">affected</span>
</code></pre></div></div> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>This example assumes adequate access to <a href="http://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL</a> local or remote server.</p> </div> </div> <h2 id="summary">Summary</h2> <p>In this tutorial we:</p> <ul> <li>bootstrapped a data pipeline, Spec</li> <li>declaratively manged dependencies among Spec components</li> <li>used assertions to verify Specs execution meets the given criteria</li> <li>execute our Spec, data pipeline</li> <li>stored our work</li> <li>change the data pipeline backend database</li> </ul> <p>Please stay tuned for future Napkin tutorial.</p> </div> </div> <div class="search-overlay"></div> </div> <div class="site-super-footer"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <div class="table-wrapper"><table> <tr> <td> <a class="link-button active" href="/">Documentation</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> </td> <td> <span class="gradient-border"> <a class="link-button" href="/install/">Get Napkin</a> </span> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/about" target="_blank" rel="noopener noreferrer">About Napkin</a> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/contact" target="_blank" rel="noopener noreferrer">Contact</a> </td> </tr> </table></div> </div> <div class="media-bar"> <div class="media-pad"><a href="#" class="inline-icon facebook"></a></div> <div class="media-pad"><a href="#" class="inline-icon twitter"></a></div> <div class="media-pad"><a href="#" class="inline-icon linked-in"></a></div> </div> <div class="copyright"> <div class="left"> Copyright 2022 © </div> <div class="right"> Made with <span class="heart"> </span> in NYC </div> </div> </div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
