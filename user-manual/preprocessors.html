<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Preprocessors</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Preprocessors" /> <meta name="author" content="Kamil Figiela" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems." /> <meta property="og:description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems." /> <link rel="canonical" href="https://soostone.github.io/user-manual/preprocessors" /> <meta property="og:url" content="https://soostone.github.io/user-manual/preprocessors" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Preprocessors" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Kamil Figiela"},"url":"https://soostone.github.io/user-manual/preprocessors","@type":"WebPage","description":"Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems.","headline":"Preprocessors","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/js/resize.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting started</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/install/" class="nav-list-link">Installation</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/install#native" class="nav-list-link">Native</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#homebrew" class="nav-list-link">Homebrew</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#cachix" class="nav-list-link">Cachix</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link">Tutorial</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/fundamentals/" class="nav-list-link">Fundamentals</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link">Tips and Tricks</a></li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/spec-arguments" class="nav-list-link">Spec arguments</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/yaml-reference" class="nav-list-link">Spec YAML reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection" class="nav-list-link">Connecting to the database</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/cli-reference" class="nav-list-link">CLI reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/multi-environment" class="nav-list-link">Multi-environment pipelines in a team setting</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/mustache" class="nav-list-link">Mustache Interpolation</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/devcontainer" class="nav-list-link">Devcontainer</a></li>
<li class="nav-list-item active"><a href="https://soostone.github.io/user-manual/preprocessors" class="nav-list-link active">Preprocessors</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/github-actions" class="nav-list-link">Running as a scheduled job on GitHub Actions</a></li>
</ul>
</li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/metaprogramming" class="nav-list-link">Metaprogramming</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/haskell" class="nav-list-link">Haskell API</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/repl" class="nav-list-link">REPL</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">API Reference</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/changelog/" class="nav-list-link">Changelog</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/ide" class="nav-list-link">IDE Support</a></li>
</ul> </nav> </div> <div class="site-super-header"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <a class="link-button active" href="/">Documentation</a> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> <span class="gradient-border"> <a class="link-button" href="/install/">Install</a> </span> </div> </div> </div> <div class="width-ruler"></div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://soostone.github.io/user-manual/">User Manual</a></li> <li class="breadcrumb-nav-list-item"><span>Preprocessors</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <ul id="markdown-toc"> <li>
<a href="#preprocessors" id="markdown-toc-preprocessors">Preprocessors</a> <ul> <li>
<a href="#built-in-preprocessors" id="markdown-toc-built-in-preprocessors">Built-in preprocessors</a> <ul> <li>
<a href="#table_prefix" id="markdown-toc-table_prefix">table_prefix</a> <ul> <li><a href="#example-segregating-environments" id="markdown-toc-example-segregating-environments">Example: Segregating environments</a></li> <li><a href="#example-isolating-development-environments" id="markdown-toc-example-isolating-development-environments">Example: Isolating development environments</a></li> </ul> </li> <li>
<a href="#table_namespace" id="markdown-toc-table_namespace">table_namespace</a> <ul> <li><a href="#example-segregating-environments-1" id="markdown-toc-example-segregating-environments-1">Example: Segregating environments</a></li> <li><a href="#example-segregating-output-tables-by-the-audience" id="markdown-toc-example-segregating-output-tables-by-the-audience">Example: Segregating output tables by the audience</a></li> </ul> </li> </ul> </li> <li><a href="#custom-preprocessors" id="markdown-toc-custom-preprocessors">Custom preprocessors</a></li> </ul> </li> </ul> <h1 id="preprocessors">Preprocessors</h1> <p>Preprocessors allow to systematically apply certain modifications to the Spec. Napkin has two preprocessors that facilitate table renaming built-in. Additionally, the user may implement custom preprocessors when needed.</p> <p>Preprocessors are configured in the <code class="language-plaintext highlighter-rouge">preprocessors</code> section of the YAML file. Multiple preprocessors can be used in a single spec, they will be applied in sequence. The syntax can be summarized as follows:</p> <p class="text-delta text-center">spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">builtin_a</span><span class="pi">:</span> <span class="c1"># built-in preprocessor with arguments</span>
      <span class="na">param_foo</span><span class="pi">:</span> <span class="s">foo</span>
      <span class="na">param_bar</span><span class="pi">:</span> <span class="s">bar</span>
  <span class="pi">-</span> <span class="s">builtin_b</span> <span class="c1"># built-in preprocessor without arguments</span>
  <span class="pi">-</span> <span class="na">MyPreprocessors.custom_a</span><span class="pi">:</span> <span class="c1"># custom preprocessor with arguments</span>
      <span class="na">param_foo</span><span class="pi">:</span> <span class="s">foo</span>
      <span class="na">param_bar</span><span class="pi">:</span> <span class="s">bar</span>
  <span class="pi">-</span> <span class="s">MyPreprocessors.custom_b</span> <span class="c1"># custom preprocessor without arguments</span>
</code></pre></div></div> <h2 id="built-in-preprocessors">Built-in preprocessors</h2> <h3 id="table_prefix">table_prefix</h3> <p>This preprocessor adds a prefix to table references. The tables are renamed when created by Napkin and all the queries are updated accordingly. By default, it affects only managed tables but can be also applied to unmanaged tables as well.</p> <p>Arguments:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">value</code> – prefix, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">override_with_arg</code> – indicates the name of spec argument that allows overriding prefix with <code class="language-plaintext highlighter-rouge">--arg</code> CLI option, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">separator</code> – the preprocessor will insert an optional separator between prefix and table name if the prefix is not empty.</li> <li>
<code class="language-plaintext highlighter-rouge">scope</code> – indicates the tables that should be prefixed, optional, can be one of: <ul> <li>
<code class="language-plaintext highlighter-rouge">managed</code> (default)</li> <li><code class="language-plaintext highlighter-rouge">unmanaged</code></li> <li><code class="language-plaintext highlighter-rouge">all</code></li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">only</code> – allows applying the renamer to selected tables only, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">except</code> – allows applying the renamer to all but selected tables, optional.</li> </ul> <h4 id="example-segregating-environments">Example: Segregating environments</h4> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>Please refer to our <a href="/user-manual/multi-environment">Multi-environment pipelines in a team setting</a> tutorial for recommended setup.</p> </div> </div> <p class="text-delta text-center">Prefix managed tables with environment</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">table_prefix</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">development</span>
      <span class="na">override_with_arg</span><span class="pi">:</span> <span class="s">environment</span>
      <span class="na">separator</span><span class="pi">:</span> <span class="s">_</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">managed</span>
</code></pre></div></div> <p>Napkin will rename all managed tables and prefix them with the environment name. The default environment is <code class="language-plaintext highlighter-rouge">development</code>. For staging and production runs, one needs to provide <code class="language-plaintext highlighter-rouge">--arg environment=staging</code> or <code class="language-plaintext highlighter-rouge">--arg environment=production</code> to adjust the prefix accordingly.</p> <h4 id="example-isolating-development-environments">Example: Isolating development environments</h4> <p class="text-delta text-center">Prefix managed tables with developer name</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">table_prefix</span><span class="pi">:</span>
      <span class="na">override_with_arg</span><span class="pi">:</span> <span class="s">developer</span> <span class="c1"># the preprocessor will fail if the developer name has not been provided explicitly when executing the spec</span>
      <span class="na">separator</span><span class="pi">:</span> <span class="s">_</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">managed</span>
</code></pre></div></div> <p>Napkin will rename all managed tables and prefix them with the developer name. There is no default developer name, so the preprocessor will fail and prevent Spec from running. One needs to explicitly pass <code class="language-plaintext highlighter-rouge">--arg developer=john</code> for each Spec run. Note, that if an empty developer argument will be provided (<code class="language-plaintext highlighter-rouge">--arg developer=</code>) the table names will have the original name with no extra <code class="language-plaintext highlighter-rouge">_</code>.</p> <h3 id="table_namespace">table_namespace</h3> <p>This preprocessor sets the namespace (BigQuery dataset or Postgres schema) to all table references. The table namespaces are renamed when created by Napkin and all the queries are updated accordingly. By default, it affects only managed tables but can be also applied to unmanaged tables as well.</p> <p>Arguments:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">value</code> – prefix, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">override_with_arg</code> – indicates the name of spec argument that allows overriding prefix with <code class="language-plaintext highlighter-rouge">--arg</code> CLI option, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">scope</code> – indicates the tables that should be prefixed, optional, can be one of: <ul> <li>
<code class="language-plaintext highlighter-rouge">managed</code> (default)</li> <li><code class="language-plaintext highlighter-rouge">unmanaged</code></li> <li><code class="language-plaintext highlighter-rouge">all</code></li> </ul> </li> <li>
<code class="language-plaintext highlighter-rouge">only</code> – allows applying the renamer to selected tables only, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">except</code> – allows applying the renamer to all but selected tables, optional.</li> <li>
<code class="language-plaintext highlighter-rouge">on_exists</code> – by default, this preprocessor will overwrite any schema that was explicitly provided in the Spec or any SQL query. This behavior can be changed to keep existing schema if any and set it only when missing, can be one of: <ul> <li>
<code class="language-plaintext highlighter-rouge">overwrite</code> (default)</li> <li><code class="language-plaintext highlighter-rouge">keep_original</code></li> </ul> </li> </ul> <h4 id="example-segregating-environments-1">Example: Segregating environments</h4> <p class="text-delta text-center">Isolate environments in namespaces</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">table_namespace</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">development</span>
      <span class="na">override_with_arg</span><span class="pi">:</span> <span class="s">environment</span>
</code></pre></div></div> <p>Napkin will move all managed tables to the environment namespace. The default environment is <code class="language-plaintext highlighter-rouge">development</code>. For staging and production runs, one needs to provide <code class="language-plaintext highlighter-rouge">--arg environment=staging</code> or <code class="language-plaintext highlighter-rouge">--arg environment=production</code> to adjust the prefix accordingly. Note that the BigQuery dataset or Postgres schema has to exist.</p> <h4 id="example-segregating-output-tables-by-the-audience">Example: Segregating output tables by the audience</h4> <p class="text-delta text-center">Isolate environments in namespaces</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">preprocessors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">table_namespace</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">data_science_internal</span> <span class="c1"># will be overwritten if necessary</span>
  <span class="pi">-</span> <span class="na">table_namespace</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">marketing</span>
      <span class="na">only</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">conversion</span>
        <span class="pi">-</span> <span class="s">customer_churn</span>
  <span class="pi">-</span> <span class="na">table_namespace</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">warehouse</span>
      <span class="na">only</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">overstock</span>
</code></pre></div></div> <p>In some cases, we need to segregate tables by the expected audience and possibly limit access to the data. In the above example, we put all managed tables to <code class="language-plaintext highlighter-rouge">data_science_internal</code>. We only store selected tables in separate namespaces. Database engine ACL can be used to configure access rules as needed.</p> <h2 id="custom-preprocessors">Custom preprocessors</h2> <p>Coming soon <img class="emoji" title=":zzz:" alt=":zzz:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a4.png" height="20" width="20"></p> </div> </div> <div class="search-overlay"></div> </div> <div class="site-super-footer"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <div class="table-wrapper"><table> <tr> <td> <a class="link-button active" href="/">Documentation</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> </td> <td> <span class="gradient-border"> <a class="link-button" href="/install/">Get Napkin</a> </span> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/about" target="_blank" rel="noopener noreferrer">About Napkin</a> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/contact" target="_blank" rel="noopener noreferrer">Contact</a> </td> </tr> </table></div> </div> <div class="media-bar"> <div class="media-pad"><a href="#" class="inline-icon facebook"></a></div> <div class="media-pad"><a href="#" class="inline-icon twitter"></a></div> <div class="media-pad"><a href="#" class="inline-icon linked-in"></a></div> </div> <div class="copyright"> <div class="left"> Copyright 2022 © </div> <div class="right"> Made with <span class="heart"> </span> in NYC </div> </div> </div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
