<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Mustache Interpolation</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Mustache Interpolation" /> <meta name="author" content="Alex Shestakov" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres, Sqlite and other NoSql/SQL systems." /> <meta property="og:description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres, Sqlite and other NoSql/SQL systems." /> <link rel="canonical" href="https://soostone.github.io/user-manual/mustache/" /> <meta property="og:url" content="https://soostone.github.io/user-manual/mustache/" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Mustache Interpolation" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Alex Shestakov"},"url":"https://soostone.github.io/user-manual/mustache/","@type":"WebPage","description":"Napkin tutorials for data scientists and analytics using BigQuery, Postgres, Sqlite and other NoSql/SQL systems.","headline":"Mustache Interpolation","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/js/resize.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting started</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/install/" class="nav-list-link">Installation</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/install#native" class="nav-list-link">Native</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#homebrew" class="nav-list-link">Homebrew</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#cachix" class="nav-list-link">Cachix</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/fundamentals/" class="nav-list-link">Fundamentals</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link">Tips and Tricks</a></li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/cli-reference/" class="nav-list-link">CLI reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection/" class="nav-list-link">Connecting to the database</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/devcontainer/" class="nav-list-link">Devcontainer</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/docker/" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/ide/" class="nav-list-link">IDE Support</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/multi-environment/" class="nav-list-link">Multi-environment pipelines in a team setting</a></li>
<li class="nav-list-item active"><a href="https://soostone.github.io/user-manual/mustache/" class="nav-list-link active">Mustache Interpolation</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/preprocessors/" class="nav-list-link">Preprocessors</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/github-actions/" class="nav-list-link">Running as a scheduled job on GitHub Actions</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/yaml-reference/" class="nav-list-link">Spec YAML reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/spec-arguments/" class="nav-list-link">Spec arguments</a></li>
</ul>
</li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/metaprogramming/" class="nav-list-link">Metaprogramming</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/haskell/" class="nav-list-link">Haskell API</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/repl/" class="nav-list-link">REPL</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/custom-hooks/" class="nav-list-link">Writing Custom Hooks</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">API Reference</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/changelog/" class="nav-list-link">Changelog</a></li>
</ul> </nav> </div> <div class="site-super-header"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <a class="link-button active" href="/">Documentation</a> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> <span class="gradient-border"> <a class="link-button" href="/install/">Install</a> </span> </div> </div> </div> <div class="width-ruler"></div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://soostone.github.io/user-manual/">User Manual</a></li> <li class="breadcrumb-nav-list-item"><span>Mustache Interpolation</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <ul id="markdown-toc"> <li>
<a href="#mustache-interpolation" id="markdown-toc-mustache-interpolation">Mustache Interpolation</a> <ul> <li><a href="#variable-substitution" id="markdown-toc-variable-substitution">Variable substitution</a></li> <li><a href="#mustache-sections" id="markdown-toc-mustache-sections">Mustache sections</a></li> <li><a href="#haskell-splicing" id="markdown-toc-haskell-splicing">Haskell splicing</a></li> </ul> </li> </ul> <h1 id="mustache-interpolation">Mustache Interpolation</h1> <p>Mustache templates interpolation is the core feature of Napkin. It is used by Napkin internally (for incremental queries) and can be utilized by users to achieve some variability in the queries, which Napkin will execute on the database.</p> <p>Every SQL file or query Napkin tries to parse is treated as a mustache template, where things like <code class="language-plaintext highlighter-rouge">{{{variable}}}</code> will be replaced with the value of the <code class="language-plaintext highlighter-rouge">variable</code>.</p> <p>The typical use cases for variable interpolation are:</p> <ul> <li>query deduplication – reusable query can be stored in a SQL file and used with different variable values to create multiple tables,</li> <li>customizing queries by passing arguments via CLI (<code class="language-plaintext highlighter-rouge">--arg</code>) options.</li> </ul> <p>Let’s demonstrate the concept with a single example: we want to define a query, which will create <code class="language-plaintext highlighter-rouge">artist_of_the_month</code> view. The table should contain only artists with names starting from the first letter of the current month’s name.</p> <h2 id="variable-substitution">Variable substitution</h2> <div class="premonition info"> <i class="premonition pn-info"></i> <div class="content"> <p>Here we assume, that chinook database is already loaded into <code class="language-plaintext highlighter-rouge">data/chinook-sql.db</code> sqlite file. Follow the “<a href="/fundamentals/#get-example-dataset">Get example dataset</a>” part of the tutorial for the details.</p> </div> </div> <p>We start from defining the idea in the <code class="language-plaintext highlighter-rouge">spec.yaml</code> file:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_of_the_month</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_query</span><span class="pi">:</span>
        <span class="na">query</span><span class="pi">:</span> <span class="s">SELECT * FROM Artist WHERE Name LIKE upper('{{{letter}}}') || '%'</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">letter</span><span class="pi">:</span> <span class="s">j</span> <span class="c1"># (stands for January)</span>
</code></pre></div></div> <p>Running such Napkin spec creates a desired view:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--verbose</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Determining</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">update</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Tables</span> <span class="n">in</span> <span class="n">execution</span> <span class="nl">plan:</span>
<span class="nl">artist_of_the_month:</span> <span class="nc">Execute</span> <span class="o">/</span> <span class="nc">UpdateStrategy</span> <span class="nc">UpdateAlways</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Forced</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Skipped</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Unmanaged</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="nc">Artist</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="nl">updated:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">updated</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="n">artist_of_the_month</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Estimated</span> <span class="nl">runtime:</span> <span class="mi">0</span><span class="n">s</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span> <span class="n">action</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">DROP</span> <span class="no">VIEW</span> <span class="no">IF</span> <span class="no">EXISTS</span> <span class="s">"artist_of_the_month"</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">CREATE</span> <span class="no">VIEW</span> <span class="s">"artist_of_the_month"</span> <span class="no">AS</span>
<span class="no">SELECT</span> <span class="o">*</span>
<span class="no">FROM</span> <span class="s">"Artist"</span> <span class="no">AS</span> <span class="s">"Artist"</span>
<span class="no">WHERE</span> <span class="o">(</span><span class="s">"Name"</span> <span class="n">like</span> <span class="o">(</span><span class="n">upper</span><span class="o">(</span><span class="sc">'j'</span><span class="o">)</span> <span class="o">||</span> <span class="sc">'%'</span><span class="o">))</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"artist_of_the_month"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"artist_of_the_month"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.00</span> <span class="nc">Server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">08</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">27</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Run</span> <span class="n">complete</span><span class="o">.</span> <span class="nc">Total</span> <span class="nl">cost:</span> <span class="n">unknown</span>
</code></pre></div></div> <p>This feature is useful for cases when you have to define multiple very similar tables. Let’s imagine we need a single view per month.</p> <p>First, we move query to the single <code class="language-plaintext highlighter-rouge">sql/artist_per_month.sql</code> file:</p> <p class="text-delta text-center">sql/artist_per_month.sql</p> <div class="language-sql copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Artist</span> <span class="k">WHERE</span> <span class="n">Name</span> <span class="k">LIKE</span> <span class="k">upper</span><span class="p">(</span><span class="s1">'{{{letter}}}'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">'%'</span>
</code></pre></div></div> <p>And the <code class="language-plaintext highlighter-rouge">spec.yaml</code> spec would look like that:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">sql_folder</span><span class="pi">:</span> <span class="s">../sql</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_for_january</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">artist_per_month.sql</span>
        <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">letter</span><span class="pi">:</span> <span class="nv">j</span> <span class="pi">}</span>

  <span class="na">artist_for_february</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">artist_per_month.sql</span>
        <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">letter</span><span class="pi">:</span> <span class="nv">f</span> <span class="pi">}</span>

  <span class="na">artist_for_march</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_file</span><span class="pi">:</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">artist_per_month.sql</span>
        <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">letter</span><span class="pi">:</span> <span class="nv">m</span> <span class="pi">}</span>
</code></pre></div></div> <p>Yes, this is still repetitive table definitions (see <a href="/metaprogramming/">Haskell API</a> section to know how to avoid that), but at least the query itself is only defined once.</p> <p>But this is not very interesting, hard-coding a letter whenever next month coming isn’t fun. Lets try to provide a variable name from the outside of the <code class="language-plaintext highlighter-rouge">spec.yaml</code> file.</p> <p>First, lets try to remove the variable definition from the spec, leaving it undefined:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_of_the_month</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_query</span><span class="pi">:</span>
        <span class="na">query</span><span class="pi">:</span> <span class="s">SELECT * FROM Artist WHERE Name LIKE upper('{{{letter}}}') || '%'</span>
</code></pre></div></div> <p>Napkin tries to protect from users from accidental mistakes, which are possible from following the mustache interpolation semantics (which treats non defined variables as empty). Running <a href="/user-manual/cli-reference/#validate"><code class="language-plaintext highlighter-rouge">validate</code></a> command with additional <code class="language-plaintext highlighter-rouge">--strict-mustache</code> flag does detects a problem with undefined variable:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin validate <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--strict-mustache</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-js text-wrap highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Spec</span> <span class="nx">error</span> <span class="nx">artist_of_the_month</span><span class="p">:</span> <span class="nx">Could</span> <span class="nx">not</span> <span class="nx">load</span> <span class="nx">inline</span> <span class="nx">sql</span><span class="p">:</span> <span class="nx">Failed</span> <span class="nx">to</span> <span class="nx">process</span> <span class="nx">mustache</span> <span class="nx">template</span><span class="p">:</span> <span class="nx">Template</span> <span class="nx">Engine</span> <span class="nb">Error</span><span class="p">:</span> <span class="k">in</span> <span class="s2">`SELECT * FROM Artist WHERE Name LIKE upper('{{{letter}}}'...`</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">message</span><span class="p">:</span> <span class="nx">Interpolation</span> <span class="nx">warning</span><span class="p">:</span> <span class="nx">Referenced</span> <span class="nx">value</span> <span class="nx">was</span> <span class="nx">not</span> <span class="nx">provided</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">letter</span>
</code></pre></div></div> <p>Fortunately, there is a way out! Napkin propagates spec <a href="/user-manual/spec-arguments/">arguments</a> into mustache variables under the <code class="language-plaintext highlighter-rouge">"args"</code>. So we can <a href="/user-manual/cli-reference/#napkin-run---arg">override</a> values by providing command line arguments.</p> <p>Before doing that, we should change <code class="language-plaintext highlighter-rouge">spec.yaml</code> definition slightly, pre-pending <code class="language-plaintext highlighter-rouge">{{{letter}}}</code> variable with <code class="language-plaintext highlighter-rouge">args</code> prefix.</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_of_the_month</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_query</span><span class="pi">:</span>
        <span class="na">query</span><span class="pi">:</span> <span class="s">SELECT * FROM Artist WHERE Name LIKE upper('{{{args.letter}}}') || '%'</span>
</code></pre></div></div> <p>Now, after providing an override from CLI, Napkin creates a correct view:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--verbose</span> <span class="nt">--arg</span> <span class="nv">letter</span><span class="o">=</span>f <span class="c"># stands for February</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Determining</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">update</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Tables</span> <span class="n">in</span> <span class="n">execution</span> <span class="nl">plan:</span>
<span class="nl">artist_of_the_month:</span> <span class="nc">Execute</span> <span class="o">/</span> <span class="nc">UpdateStrategy</span> <span class="nc">UpdateAlways</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Forced</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Skipped</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Unmanaged</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="nc">Artist</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="nl">updated:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">updated</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="n">artist_of_the_month</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Estimated</span> <span class="nl">runtime:</span> <span class="mi">0</span><span class="n">s</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span> <span class="n">action</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">DROP</span> <span class="no">VIEW</span> <span class="no">IF</span> <span class="no">EXISTS</span> <span class="s">"artist_of_the_month"</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">CREATE</span> <span class="no">VIEW</span> <span class="s">"artist_of_the_month"</span> <span class="no">AS</span>
<span class="no">SELECT</span> <span class="o">*</span>
<span class="no">FROM</span> <span class="s">"Artist"</span> <span class="no">AS</span> <span class="s">"Artist"</span>
<span class="no">WHERE</span> <span class="o">(</span><span class="s">"Name"</span> <span class="n">like</span> <span class="o">(</span><span class="n">upper</span><span class="o">(</span><span class="sc">'f'</span><span class="o">)</span> <span class="o">||</span> <span class="sc">'%'</span><span class="o">))</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"artist_of_the_month"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"artist_of_the_month"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.00</span> <span class="nc">Server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">23</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Run</span> <span class="n">complete</span><span class="o">.</span> <span class="nc">Total</span> <span class="nl">cost:</span> <span class="n">unknown</span>
</code></pre></div></div> <h2 id="mustache-sections">Mustache sections</h2> <p>But what if the context of the task has suddenly changed and now we need to filter artists with names, starting with several different letters? Napkin to the rescue <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"></p> <p>Mustache supports named <strong>sections</strong> syntax, which behaves differently, depending on the variable value:</p> <ul> <li>Section is not rendered if condition variable is not defined or ‘false’ or ‘empty list’.</li> <li>Section is rendered multiple times for ‘non-empty list’, binding list element as a variable set.</li> <li>Section is rendered once for a non-empty value, binding it as a variable set.</li> </ul> <p>Lets define a query in <code class="language-plaintext highlighter-rouge">spec.yaml</code>, which utilized a section syntax and performs our changed task:</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_of_the_month</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_query</span><span class="pi">:</span>
        <span class="na">target_type</span><span class="pi">:</span> <span class="s">view</span>
        <span class="na">query</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">SELECT * FROM Artist WHERE</span>
            <span class="s">False</span>
            <span class="s">{{#args.letters}}</span>
              <span class="s">OR Name LIKE upper('{{{letter}}}') || '%'</span>
            <span class="s">{{/args.letters}}</span>
</code></pre></div></div> <p>With strict mustache evaluation mode, Napkin produces an error when variable mentioned in section name is not defined:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin validate <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--strict-mustache</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-js text-wrap highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Spec</span> <span class="nx">error</span> <span class="nx">artist_of_the_month</span><span class="p">:</span> <span class="nx">Could</span> <span class="nx">not</span> <span class="nx">load</span> <span class="nx">inline</span> <span class="nx">sql</span><span class="p">:</span> <span class="nx">Failed</span> <span class="nx">to</span> <span class="nx">process</span> <span class="nx">mustache</span> <span class="nx">template</span><span class="p">:</span> <span class="nx">Template</span> <span class="nx">Substitution</span> <span class="nb">Error</span><span class="p">:</span> <span class="k">in</span> <span class="s2">`SELECT * FROM Artist WHERE False {{^args.letters}} OR Nam...`</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">message</span><span class="p">:</span> <span class="nx">Variable</span> <span class="nx">used</span> <span class="k">in</span> <span class="nx">section</span> <span class="nx">declaration</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">defined</span><span class="p">:</span> <span class="nx">letters</span>
</code></pre></div></div> <p>Lets specify the values with <code class="language-plaintext highlighter-rouge">--arg-json</code> CLI flag:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml <span class="nt">--arg-json</span> <span class="s1">'{"letters": [{"letter": "a"}, {"letter": "b"}]}'</span> <span class="nt">--verbose</span>
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Determining</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">update</span><span class="o">...</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Tables</span> <span class="n">in</span> <span class="n">execution</span> <span class="nl">plan:</span>
<span class="nl">artist_of_the_month:</span> <span class="nc">Execute</span> <span class="o">/</span> <span class="nc">UpdateStrategy</span> <span class="nc">UpdateAlways</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Forced</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Skipped</span> <span class="nl">tables:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Unmanaged</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="nc">Artist</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span> <span class="n">input</span> <span class="n">in</span> <span class="k">this</span> <span class="n">run</span><span class="o">,</span> <span class="n">but</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span> <span class="nl">updated:</span> <span class="n">none</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Managed</span> <span class="n">tables</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">updated</span> <span class="n">in</span> <span class="k">this</span> <span class="nl">run:</span>
<span class="o">-</span> <span class="n">artist_of_the_month</span>

<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Estimated</span> <span class="nl">runtime:</span> <span class="mi">0</span><span class="n">s</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Pre</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Executing</span> <span class="n">table</span> <span class="n">action</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">DROP</span> <span class="no">VIEW</span> <span class="no">IF</span> <span class="no">EXISTS</span> <span class="s">"artist_of_the_month"</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Executing</span> <span class="nl">command:</span> <span class="no">CREATE</span> <span class="no">VIEW</span> <span class="s">"artist_of_the_month"</span> <span class="no">AS</span>
<span class="no">SELECT</span> <span class="o">*</span>
<span class="no">FROM</span> <span class="s">"Artist"</span> <span class="no">AS</span> <span class="s">"Artist"</span>
<span class="no">WHERE</span> <span class="o">((</span><span class="kc">false</span><span class="o">)</span> <span class="n">or</span> <span class="o">((</span><span class="s">"Name"</span> <span class="n">like</span> <span class="o">(</span><span class="n">upper</span><span class="o">(</span><span class="sc">'a'</span><span class="o">)</span> <span class="o">||</span> <span class="sc">'%'</span><span class="o">))))</span> <span class="n">or</span> <span class="o">((</span><span class="s">"Name"</span> <span class="n">like</span> <span class="o">(</span><span class="n">upper</span><span class="o">(</span><span class="sc">'b'</span><span class="o">)</span> <span class="o">||</span> <span class="sc">'%'</span><span class="o">)))</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Debug</span><span class="o">]</span> <span class="nc">Command</span> <span class="n">performed</span> <span class="n">in</span> <span class="mf">0.00</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">action</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Running</span> <span class="n">table</span> <span class="nf">hooks</span> <span class="o">(</span><span class="nc">Post</span><span class="o">)</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="n">processing</span> <span class="n">complete</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">TableSpec</span> <span class="s">"artist_of_the_month"</span> <span class="n">server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Execution</span> <span class="n">completed</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">see</span> <span class="n">below</span> <span class="k">for</span> <span class="n">a</span> <span class="n">summary</span><span class="o">.</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="o">----------------------------------------------------------</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Table</span> <span class="s">"artist_of_the_month"</span> <span class="n">ran</span> <span class="n">in</span> <span class="mf">0.01</span> <span class="nc">Server</span> <span class="nl">stats:</span> <span class="n">unknown</span>
<span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">51</span><span class="o">][</span><span class="nc">Info</span><span class="o">]</span> <span class="nc">Run</span> <span class="n">complete</span><span class="o">.</span> <span class="nc">Total</span> <span class="nl">cost:</span> <span class="n">unknown</span>
</code></pre></div></div> <p>This time Napkin replaces both letters and executed the correct resulting query. But there is a better way to inspect the query without asking Napkin to execute it – the <a href="/user-manual/cli-reference/#dump"><code class="language-plaintext highlighter-rouge">dump</code></a> command.</p> <p>Let’s change out query one more time, to insert a default behavior (when no letter is specified). We will use the mustache inverse section, which is executed when the expression inside it is ‘false’ or ‘empty’.</p> <p class="text-delta text-center">specs/spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">sqlite:data/chinook-sql.db</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Sqlite</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">artist_of_the_month</span><span class="pi">:</span>
    <span class="na">create_action</span><span class="pi">:</span>
      <span class="na">sql_query</span><span class="pi">:</span>
        <span class="na">target_type</span><span class="pi">:</span> <span class="s">view</span>
        <span class="na">query</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">SELECT * FROM Artist WHERE</span>
            <span class="s">False</span>
            <span class="s">{{^args.letters}}</span>
              <span class="s">OR Name = 'Metallica'</span>
            <span class="s">{{/args.letters}}</span>
            <span class="s">{{#args.letters}}</span>
              <span class="s">OR Name LIKE upper('{{{letter}}}') || '%'</span>
            <span class="s">{{/args.letters}}</span>
</code></pre></div></div> <p>Dumping the query gives us different results depending on provided arguments:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin dump <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <p class="text-delta text-center">output</p> <div class="table-wrapper"><table> <thead> <tr> <th> <p>Without <code class="language-plaintext highlighter-rouge">--arg-json</code> argument</p> </th> <th> <p>With <code class="language-plaintext highlighter-rouge">--arg-json '{"letters": {"letter": "b"}}'</code></p> </th> </tr> </thead> <tbody> <tr> <td> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="nv">"Artist"</span> <span class="k">AS</span> <span class="nv">"Artist"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="k">or</span> <span class="p">((</span><span class="nv">"Name"</span> <span class="o">=</span> <span class="s1">'Metallica'</span><span class="p">))</span>
</code></pre></div></div> </td> <td> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="nv">"Artist"</span> <span class="k">AS</span> <span class="nv">"Artist"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="k">or</span> <span class="p">((</span><span class="nv">"Name"</span> <span class="k">like</span> <span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">'%'</span><span class="p">)))</span>
</code></pre></div></div> </td> </tr> </tbody> </table></div> <h2 id="haskell-splicing">Haskell splicing</h2> <p>Coming soon <img class="emoji" title=":zzz:" alt=":zzz:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a4.png" height="20" width="20"></p> </div> </div> <div class="search-overlay"></div> </div> <div class="site-super-footer"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <div class="table-wrapper"><table> <tr> <td> <a class="link-button active" href="/">Documentation</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> </td> <td> <span class="gradient-border"> <a class="link-button" href="/install/">Get Napkin</a> </span> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/about" target="_blank" rel="noopener noreferrer">About Napkin</a> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/contact" target="_blank" rel="noopener noreferrer">Contact</a> </td> </tr> </table></div> </div> <div class="media-bar"> <div class="media-pad"><a href="#" class="inline-icon facebook"></a></div> <div class="media-pad"><a href="#" class="inline-icon twitter"></a></div> <div class="media-pad"><a href="#" class="inline-icon linked-in"></a></div> </div> <div class="copyright"> <div class="left"> Copyright 2022 © </div> <div class="right"> Made with <span class="heart"> </span> in NYC </div> </div> </div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
