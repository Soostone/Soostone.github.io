<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Docker</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Docker" /> <meta name="author" content="Alex Shestakov" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin docker manual" /> <meta property="og:description" content="Napkin docker manual" /> <link rel="canonical" href="https://soostone.github.io/user-manual/docker" /> <meta property="og:url" content="https://soostone.github.io/user-manual/docker" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Docker" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Alex Shestakov"},"url":"https://soostone.github.io/user-manual/docker","@type":"WebPage","description":"Napkin docker manual","headline":"Docker","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/js/resize.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting started</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/install/" class="nav-list-link">Installation</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/install#native" class="nav-list-link">Native</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#homebrew" class="nav-list-link">Homebrew</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#cachix" class="nav-list-link">Cachix</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link">Tutorial</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/fundamentals/" class="nav-list-link">Fundamentals</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link">Tips and Tricks</a></li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/spec-arguments" class="nav-list-link">Spec arguments</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/yaml-reference" class="nav-list-link">Spec YAML reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection" class="nav-list-link">Connecting to the database</a></li>
<li class="nav-list-item active"><a href="https://soostone.github.io/user-manual/docker" class="nav-list-link active">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/cli-reference" class="nav-list-link">CLI reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/multi-environment" class="nav-list-link">Multi-environment pipelines in a team setting</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/mustache" class="nav-list-link">Mustache Interpolation</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/devcontainer" class="nav-list-link">Devcontainer</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/preprocessors" class="nav-list-link">Preprocessors</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/github-actions" class="nav-list-link">Running as a scheduled job on GitHub Actions</a></li>
</ul>
</li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/metaprogramming" class="nav-list-link">Metaprogramming</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/repl" class="nav-list-link">REPL</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/custom-hooks" class="nav-list-link">Writing Custom Hooks</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/haskell" class="nav-list-link">Haskell API</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">API Reference</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/changelog/" class="nav-list-link">Changelog</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/ide" class="nav-list-link">IDE Support</a></li>
</ul> </nav> </div> <div class="site-super-header"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <a class="link-button active" href="/">Documentation</a> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> <span class="gradient-border"> <a class="link-button" href="/install/">Install</a> </span> </div> </div> </div> <div class="width-ruler"></div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://soostone.github.io/user-manual/">User Manual</a></li> <li class="breadcrumb-nav-list-item"><span>Docker</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <ul id="markdown-toc"> <li>
<a href="#docker" id="markdown-toc-docker">Docker</a> <ul> <li><a href="#basic-usage" id="markdown-toc-basic-usage">Basic usage</a></li> <li><a href="#advanced-usage" id="markdown-toc-advanced-usage">Advanced usage</a></li> <li>
<a href="#technical-details" id="markdown-toc-technical-details">Technical details</a> <ul> <li><a href="#assumptions-and-internals" id="markdown-toc-assumptions-and-internals">Assumptions and internals</a></li> <li><a href="#commit-policy" id="markdown-toc-commit-policy">Commit policy</a></li> </ul> </li> </ul> </li> </ul> <h1 id="docker">Docker</h1> <h2 id="basic-usage">Basic usage</h2> <p>The idea behind the docker wrapper script is simple: usage patterns should be indistinguishable from regular Napkin usage. It is possible to invoke any Napkin command, for example:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> init <span class="nt">--project-name</span> example
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> validate <span class="nt">--spec-file</span> example/specs/spec.yaml <span class="nt">--interactive</span>
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> haddock
sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> version
</code></pre></div></div> <h2 id="advanced-usage">Advanced usage</h2> <p>If your Napkin project requires some extra haskell packages, which is usually specified in <code class="language-plaintext highlighter-rouge">spec.yaml</code> file:</p> <p class="text-delta text-center">spec.yaml</p> <div class="language-yaml copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">haskell_packages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">cassava</span>
  <span class="pi">-</span> <span class="s">cassava-embed</span>
</code></pre></div></div> <p>It is still possible to use docker wrapper script like so:</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAPKIN_EXTRA_PACKAGES</span><span class="o">=</span><span class="s2">"cassava cassava-embed"</span> sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> validate
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Building custom napkin image with extra cassava cassava-embed packages, it can take a minute...
sha256:707aab0cdce3d14929134cad2d8102bb463ef4377cdad3e1c59afa62d5342689
OK
</code></pre></div></div> <p>Under the hood, wrapper script will build an extra layer to the base image with extra packages installed, so Napkin can see and use them with the following Nix expression:</p> <p class="text-delta text-center">nixpkgs.nix</p> <div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kr">import</span> <span class="sx">https://github.com/NixOS/nixpkgs/archive</span><span class="o">/</span><span class="p">$</span><span class="nv">NAPKIN_NIX_REVISION</span><span class="o">.</span><span class="nv">tar</span><span class="o">.</span><span class="nv">gz</span> <span class="p">{})</span>
  <span class="o">.</span><span class="nv">haskell</span><span class="o">.</span><span class="nv">packages</span><span class="o">.</span><span class="p">$</span><span class="nv">NAPKIN_GHC_VERSION_COMPACT</span>
  <span class="o">.</span><span class="nv">ghcWithPackages</span> <span class="p">(</span><span class="nv">p</span><span class="p">:</span> <span class="kn">with</span> <span class="nv">p</span><span class="p">;</span> <span class="p">[$</span><span class="nv">NAPKIN_EXTRA_PACKAGES</span><span class="p">])</span>
</code></pre></div></div> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>Note, that packages, specified with <code class="language-plaintext highlighter-rouge">NAPKIN_EXTRA_PACKAGES</code> variable, are pulled from Nix, so every package should exist in Nix, for example: <a href="https://search.nixos.org/packages?channel=21.11&amp;from=0&amp;size=50&amp;buckets=%7B%22package_attr_set%22%3A%5B%22haskellPackages%22%5D%2C%22package_license_set%22%3A%5B%5D%2C%22package_maintainers_set%22%3A%5B%5D%2C%22package_platforms%22%3A%5B%5D%7D&amp;sort=relevance&amp;type=packages&amp;query=cassava" target="_blank" rel="noopener noreferrer">cassava</a>).</p> </div> </div> <h2 id="technical-details">Technical details</h2> <h3 id="assumptions-and-internals">Assumptions and internals</h3> <p>Docker wrapper script provides a way to run Napkin inside a container. Being executed inside a container, it needs access to the project files you are working on. Wrapper script makes an assumption, that it will be executed from the project root folder and mounts current folder from the host machine to the <code class="language-plaintext highlighter-rouge">/project</code> folder inside a container: <code class="language-plaintext highlighter-rouge">--volume $PWD:/project</code>.</p> <p>Since Napkin uses user’s <code class="language-plaintext highlighter-rouge">$HOME</code> folder to cache BigQuery credentials in SQLite database, wrapper script also needs to mount <code class="language-plaintext highlighter-rouge">.napkin</code> folder from the host to the container: <code class="language-plaintext highlighter-rouge">--volume $HOME/.napkin:/home/napkin/.napkin</code>.</p> <p>Occasionally, Napkin wants to open some links in the user’s browser (docs, BigQuery oAuth flow, etc.). Since there is no access to the host’s browser from the running container, wrapper scripts mounts a host-container <code class="language-plaintext highlighter-rouge">pipe</code> (temp folder based), sets up own tiny browser wrapper inside a container <code class="language-plaintext highlighter-rouge">--volume $open:/tmp/open --volume $inbox:/tmp/inbox</code>, listens to any invocations on the host, and opens host’s browser normally with help of standard <code class="language-plaintext highlighter-rouge">open</code> (on Mac) or <code class="language-plaintext highlighter-rouge">xdg-open</code> (on Linux) utilities. It is also possible to specify preferred browser with <code class="language-plaintext highlighter-rouge">BROWSER</code> environment variable.</p> <p>BigQuery oAuth flow requires program to have a valid HTTP callback (has to be on localhost in case of standalone desktop program). But since Napkin in being run inside a container, wrapper script publishes the port from a container to host machine <code class="language-plaintext highlighter-rouge">--publish $oauth_port:9901</code>, which possible to override with corresponding environment variable: <code class="language-plaintext highlighter-rouge">oauth_port="${NAPKIN_OAUTH_PORT:=9901}"</code>.</p> <h3 id="commit-policy">Commit policy</h3> <p>Wrapper script, extracted out of docker container to the host filesystem, contains exact versions of Napkin, nixpkgs and GHC compiler.</p> <p class="text-delta text-center">napkin-docker</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">image</span><span class="o">=</span><span class="s2">"soostone/napkin-exe:v0.5.7-9db950fa"</span>
<span class="nv">NAPKIN_GHC_VERSION_COMPACT</span><span class="o">=</span><span class="s2">"ghc8107"</span>
<span class="nv">NAPKIN_GHC_VERSION</span><span class="o">=</span><span class="s2">"ghc-8.10.7"</span>
</code></pre></div></div> <p>That is precisely why on first use you see such output from docker in your terminal (but on on subsequent invocations):</p> <p class="text-delta text-center">shell</p> <div class="language-sh copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh &lt;<span class="o">(</span>docker run <span class="nt">--rm</span> soostone/napkin-exe <span class="nb">cat</span> /bin/napkin-docker<span class="o">)</span> version
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unable to find image 'soostone/napkin-exe:v0.5.7-9db950fa' locally
v0.5.7-9db950fa: Pulling from soostone/napkin-exe
Digest: sha256:cccb09930b22216a7ab97f0eef0d4299d4a62a3e44928d23e88085eb25d98159
Status: Downloaded newer image for soostone/napkin-exe:v0.5.7-9db950fa
Napkin version: 0.5.7
Git commit hash: 9db950fad2469ed88522976f700c3f7446eb5176
Built at: 2021-12-02 17:35:21.03233944 UTC
</code></pre></div></div> <p>Since wrapper script has docker image tag as <code class="language-plaintext highlighter-rouge">soostone/napkin-exe:v0.5.7-9db950fa</code> and not just <code class="language-plaintext highlighter-rouge">soostone/napkin-exe:latest</code>, it does an extra <code class="language-plaintext highlighter-rouge">pull</code>, but quickly realize then images are the same.</p> <p>It is recommended to commit the wrapper script to the project git repository, so that other team members will use it.</p> </div> </div> <div class="search-overlay"></div> </div> <div class="site-super-footer"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <div class="table-wrapper"><table> <tr> <td> <a class="link-button active" href="/">Documentation</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> </td> <td> <span class="gradient-border"> <a class="link-button" href="/install/">Get Napkin</a> </span> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/about" target="_blank" rel="noopener noreferrer">About Napkin</a> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/contact" target="_blank" rel="noopener noreferrer">Contact</a> </td> </tr> </table></div> </div> <div class="media-bar"> <div class="media-pad"><a href="#" class="inline-icon facebook"></a></div> <div class="media-pad"><a href="#" class="inline-icon twitter"></a></div> <div class="media-pad"><a href="#" class="inline-icon linked-in"></a></div> </div> <div class="copyright"> <div class="left"> Copyright 2022 © </div> <div class="right"> Made with <span class="heart"> </span> in NYC </div> </div> </div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
