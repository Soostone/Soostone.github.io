<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Writing Custom Hooks</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Writing Custom Hooks" /> <meta name="author" content="Kamil Figiela" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems." /> <meta property="og:description" content="Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems." /> <link rel="canonical" href="https://soostone.github.io/metaprogramming/custom-hooks/" /> <meta property="og:url" content="https://soostone.github.io/metaprogramming/custom-hooks/" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Writing Custom Hooks" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Kamil Figiela"},"url":"https://soostone.github.io/metaprogramming/custom-hooks/","@type":"WebPage","description":"Napkin tutorials for data scientists and analytics using BigQuery, Postgres and other NoSql/SQL systems.","headline":"Writing Custom Hooks","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/js/resize.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewbox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list">
<li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link">About</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting started</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/install/" class="nav-list-link">Installation</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/install#native" class="nav-list-link">Native</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#homebrew" class="nav-list-link">Homebrew</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#docker" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/install#cachix" class="nav-list-link">Cachix</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/fundamentals/" class="nav-list-link">Fundamentals</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link">Tips and Tricks</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/mustache/" class="nav-list-link">Mustache Interpolation</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/yaml-reference/" class="nav-list-link">Spec YAML reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/spec-arguments/" class="nav-list-link">Spec arguments</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection/" class="nav-list-link">Connecting to the database</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/docker/" class="nav-list-link">Docker</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/cli-reference/" class="nav-list-link">CLI reference</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/multi-environment/" class="nav-list-link">Multi-environment pipelines in a team setting</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/devcontainer/" class="nav-list-link">Devcontainer</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/preprocessors/" class="nav-list-link">Preprocessors</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/user-manual/github-actions/" class="nav-list-link">Running as a scheduled job on GitHub Actions</a></li>
</ul>
</li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander"><svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://soostone.github.io/metaprogramming/" class="nav-list-link">Metaprogramming</a><ul class="nav-list ">
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/repl/" class="nav-list-link">REPL</a></li>
<li class="nav-list-item active"><a href="https://soostone.github.io/metaprogramming/custom-hooks/" class="nav-list-link active">Writing Custom Hooks</a></li>
<li class="nav-list-item "><a href="https://soostone.github.io/metaprogramming/haskell/" class="nav-list-link">Haskell API</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">API Reference</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/changelog/" class="nav-list-link">Changelog</a></li>
<li class="nav-list-item"><a href="https://soostone.github.io/ide/" class="nav-list-link">IDE Support</a></li>
</ul> </nav> </div> <div class="site-super-header"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <a class="link-button active" href="/">Documentation</a> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> <span class="gradient-border"> <a class="link-button" href="/install/">Install</a> </span> </div> </div> </div> <div class="width-ruler"></div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://soostone.github.io/metaprogramming/">Metaprogramming</a></li> <li class="breadcrumb-nav-list-item"><span>Writing Custom Hooks</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="writing-custom-hooks-with-haskell">Writing Custom Hooks with Haskell</h1> <p>Custom hooks have a type of <code class="language-plaintext highlighter-rouge">HookProgram backend</code> and they can be exposed to be available through YAML Spec by implementing an additional wrapper for passing arguments from YAML. Custom hooks can be used to implement assertions on data stored in the database (managed or unmanaged tables), as well as, to perform extra operations before or after table spec is executed. In contrast to custom spec programs, hooks are allowed to perform arbitrary IO, such as storing files on a disk or uploading results to cloud storage.</p> <div class="premonition note"> <i class="premonition pn-note"></i> <div class="content"> <p>Napkin does not include tables accessed by hooks in the dependency graph used to create an execution plan.</p> </div> </div> <p>Let’s implement a custom hook that we will later use as a pre-hook to check source tables are present in the database.</p> <p>First, let’s create a Haskell file <code class="language-plaintext highlighter-rouge">haskell/CustomHooks.hs</code> in the project folder.</p> <p class="text-delta text-center">haskell/CustomHooks.hs</p> <div class="language-haskell copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">CustomHooks</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Control.Lens</span> <span class="p">((</span><span class="o">&amp;</span><span class="p">),</span> <span class="p">(</span><span class="o">.~</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Data.Aeson</span> <span class="p">((</span><span class="o">.:</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Napkin.Backends.Base</span>
</code></pre></div></div> <p>Next, we will define our hook program. It will accept a list of tables that need to be checked. It will use <code class="language-plaintext highlighter-rouge">mapM_</code> to iterate over the list provided, <code class="language-plaintext highlighter-rouge">checkTableExists</code> will perform a check for table existence, and finally, we’ll assert the result value. We will use the <code class="language-plaintext highlighter-rouge">failLater</code> helper to make sure that all checks will be executed. Otherwise, the first failure would short-circuit the remaining checks.</p> <p class="text-delta text-center">haskell/CustomHooks.hs</p> <div class="language-haskell copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">checkManyTablesExistHook</span> <span class="o">::</span> <span class="p">[</span><span class="kt">Ref</span> <span class="kt">Table</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kt">HookProgram</span> <span class="n">backend</span>
<span class="n">checkManyTablesExistHook</span> <span class="o">=</span> <span class="n">mapM_</span> <span class="o">$</span> <span class="nf">\</span><span class="n">tableName</span> <span class="o">-&gt;</span> <span class="n">failLater</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">checkResult</span> <span class="o">&lt;-</span> <span class="n">checkTableExists</span> <span class="n">tableName</span>
  <span class="n">assertTrue</span> <span class="p">(</span><span class="s">"check if table "</span> <span class="o">&lt;&gt;</span> <span class="n">refText</span> <span class="n">tableName</span> <span class="o">&lt;&gt;</span> <span class="s">" exists"</span><span class="p">)</span> <span class="n">checkResult</span>
</code></pre></div></div> <div class="premonition info"> <i class="premonition pn-info"></i> <div class="content"> <p class="header">Testing hooks</p>
<p>Hooks can be easily tested in a REPL environment. Please refer to <a href="%%7Blink%20metaprogramming/repl.markdown%20%%7D">REPL</a> tutorial.</p> </div> </div> <p>In this form, we could already use our custom hook from Haskell-based spec:</p> <div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">spec</span> <span class="o">::</span> <span class="kt">Spec</span> <span class="n">b</span> <span class="nb">()</span>
<span class="n">spec</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="n">defineTable</span> <span class="o">$</span>
    <span class="n">tableWithQuery</span> <span class="s">"sometable"</span> <span class="n">someQuery</span>
      <span class="o">&amp;</span> <span class="n">specPreHooks</span> <span class="o">.~</span> <span class="p">[</span><span class="kt">CustomHooks</span><span class="o">.</span><span class="n">checkManyTablesExistHook</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">,</span> <span class="s">"bar"</span><span class="p">,</span> <span class="s">"baz"</span><span class="p">]]</span>
</code></pre></div></div> <p>However, we can also expose our custom hook to be used from YAML specs. To do this, we need to implement an argument parser. To do this, we implement a simple <a href="https://hackage.haskell.org/package/aeson/docs/Data-Aeson.html" target="_blank" rel="noopener noreferrer">Aeson</a> parser that will return <code class="language-plaintext highlighter-rouge">HookProgram backend</code>. Note that the parser has to be wrapped with <code class="language-plaintext highlighter-rouge">HookProgramWithArgParser</code> newtype constructor.</p> <div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">checkManyTablesExist</span> <span class="o">::</span> <span class="kt">HookProgramWithArgParser</span> <span class="n">backend</span>
<span class="n">checkManyTablesExist</span> <span class="o">=</span> <span class="kt">HookProgramWithArgParser</span> <span class="o">$</span> <span class="nf">\</span><span class="n">obj</span> <span class="o">-&gt;</span> <span class="kr">do</span>
  <span class="n">tables</span> <span class="o">::</span> <span class="p">[</span><span class="kt">Ref</span> <span class="kt">Table</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">obj</span> <span class="o">.:</span> <span class="s">"tables"</span>
  <span class="n">pure</span> <span class="o">$</span> <span class="n">checkManyTablesExistHook</span> <span class="n">tables</span>
</code></pre></div></div> <p>With that function implemented, we may refer to the hook in YAML-based spec:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">some_table</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">post_hooks</span><span class="err">:</span>
      <span class="pi">-</span> <span class="na">CustomHooks.checkManyTablesExist</span><span class="pi">:</span>
          <span class="na">tables</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">foo</span>
            <span class="pi">-</span> <span class="s">bar</span>
            <span class="pi">-</span> <span class="s">baz</span>
</code></pre></div></div> <p>In some cases, hooks will not accept any arguments. <code class="language-plaintext highlighter-rouge">parserlessHook</code> can be used to reduce boilerplate necessary:</p> <p class="text-delta text-center">haskell/CustomHooks.hs</p> <div class="language-haskell copyable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">veryCustomHook</span> <span class="o">::</span> <span class="kt">HookProgramWithArgParser</span> <span class="n">backend</span>
<span class="n">veryCustomHook</span> <span class="o">=</span> <span class="n">parserlessHook</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">logInfo</span> <span class="s">"Runnin veryCustomHook logic"</span>
</code></pre></div></div> <p>This hook can be referenced from YAML as well:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="na">tables</span><span class="pi">:</span>
  <span class="na">some_table</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">post_hooks</span><span class="err">:</span>
      <span class="pi">-</span> <span class="s">CustomHooks.veryCustomHook</span>
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> <div class="site-super-footer"> <div class="super-nav-box"> <div class="site-logo"></div> <div class="site-buttons"> <div class="table-wrapper"><table> <tr> <td> <a class="link-button active" href="/">Documentation</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/usecases" target="_blank" rel="noopener noreferrer">Use Cases</a> </td> <td> <span class="gradient-border"> <a class="link-button" href="/install/">Get Napkin</a> </span> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/community" target="_blank" rel="noopener noreferrer">Community</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/about" target="_blank" rel="noopener noreferrer">About Napkin</a> </td> </tr> <tr> <td> <a class="link-button" href="https://napkinweb.webflow.io/features" target="_blank" rel="noopener noreferrer">Features</a> </td> <td> <a class="link-button" href="https://napkinweb.webflow.io/contact" target="_blank" rel="noopener noreferrer">Contact</a> </td> </tr> </table></div> </div> <div class="media-bar"> <div class="media-pad"><a href="#" class="inline-icon facebook"></a></div> <div class="media-pad"><a href="#" class="inline-icon twitter"></a></div> <div class="media-pad"><a href="#" class="inline-icon linked-in"></a></div> </div> <div class="copyright"> <div class="left"> Copyright 2022 © </div> <div class="right"> Made with <span class="heart"> </span> in NYC </div> </div> </div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
