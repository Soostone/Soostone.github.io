<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Tutorial - Napkin Wiki</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Tutorial | Napkin Wiki</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Tutorial" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin Wiki with howtos and tutorials." /> <meta property="og:description" content="Napkin Wiki with howtos and tutorials." /> <link rel="canonical" href="/tutorial/" /> <meta property="og:url" content="/tutorial/" /> <meta property="og:site_name" content="Napkin Wiki" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Tutorial" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/tutorial/","description":"Napkin Wiki with howtos and tutorials.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo-and-name.svg"}},"headline":"Tutorial","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <li class="nav-list-item"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/getting-started/" class="nav-list-link">Getting Started</a></li><li class="nav-list-item active"><a href="/tutorial/" class="nav-list-link active">Tutorial</a></li><li class="nav-list-item"><a href="/user-manual/" class="nav-list-link">User Manual</a></li><li class="nav-list-item"><a href="/haddock/" class="nav-list-link">Haddock</a></li></ul> </nav> <footer class="site-footer"> <span>Copyright &copy; 2020-2021 <a href="http://soostone.com/" class="black"> <img style="height: 13px; vertical-align: bottom; padding-left: 5px;" src="/assets/images/logo-gem-100.png" /> Soostone </a> </span> </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Napkin Wiki" aria-label="Search Napkin Wiki" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <ol id="markdown-toc"> <li><a href="#tutorial" id="markdown-toc-tutorial">Tutorial</a> <ol> <li><a href="#spec-project" id="markdown-toc-spec-project">Spec project</a></li> <li><a href="#sales-db-demo" id="markdown-toc-sales-db-demo">Sales DB demo</a> <ol> <li><a href="#schema-and-input-data" id="markdown-toc-schema-and-input-data">Schema and Input Data</a></li> <li><a href="#napkin-queries" id="markdown-toc-napkin-queries">Napkin Queries</a></li> </ol> </li> <li><a href="#mustache-template-and-variable-interpolation" id="markdown-toc-mustache-template-and-variable-interpolation">Mustache template and variable interpolation</a></li> <li><a href="#chain-of-queries" id="markdown-toc-chain-of-queries">Chain of queries</a></li> <li><a href="#sql-macro-functions" id="markdown-toc-sql-macro-functions">SQL macro functions</a></li> <li><a href="#backends" id="markdown-toc-backends">Backends</a></li> <li><a href="#bigquery" id="markdown-toc-bigquery">BigQuery</a></li> <li><a href="#embedded-haskell" id="markdown-toc-embedded-haskell">Embedded Haskell</a> <ol> <li><a href="#evaluation-haskell-through-eval" id="markdown-toc-evaluation-haskell-through-eval">Evaluation Haskell through <strong>eval</strong></a></li> </ol> </li> </ol> </li> </ol> <h1 id="tutorial"> <a href="#tutorial" class="anchor-heading" aria-labelledby="tutorial"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tutorial </h1> <h2 id="spec-project"> <a href="#spec-project" class="anchor-heading" aria-labelledby="spec-project"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Spec project </h2> <p>Napkin project is called <strong>Spec</strong>. It is <a href="https://en.wikipedia.org/wiki/YAML">a YAML file</a> enumerating <a href="https://en.wikipedia.org/wiki/SQL">SQL</a>/<a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> tables in a <a href="https://en.wikipedia.org/wiki/Database">DB</a>. These tables comprise an implicit <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a>, where edges are references to fields from other tables.</p> <p>Usually <em>source tables</em> are real tables/materialized views enfilled independently with data by other applications or as a result of manual manipulations with tables through <em>pgsql</em> e.g. Their data prexist from Napkin point of view. Napkin is a tool for describing observable, reproducable and adjustable way of refining raw data from source tables and storing them into <em>sink ones</em>.</p> <p>A typical sink table is an opposite to source one. It could be empty and don’t event exist in a DB at the time Napkin gets hands dirty. A sink table is described by a selecting SQL query referring source tables.</p> <p>“The road to truth has many turns.” and getting data for sink tables at one step could be hard. Usually it is easier to extract from an onion style query several intermediate subqueries and refer to them as tables. These intermediate materialized tables give greater space for maneuvering and serve as cache, plus intermediate tables could be reused in other sink tables. Materialized sub queries are a greate way for debugging and introspection.</p> <h2 id="sales-db-demo"> <a href="#sales-db-demo" class="anchor-heading" aria-labelledby="sales-db-demo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sales DB demo </h2> <p>Napkin Spec file has lots of fields and the easiest way to start a project for a beginner is to leverage a spec generator feature. All it needs is a bunch of SQL files with 1 query per file.</p> <p>For a model case let’s consider a sales DB with following tables:</p> <h3 id="schema-and-input-data"> <a href="#schema-and-input-data" class="anchor-heading" aria-labelledby="schema-and-input-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Schema and Input Data </h3> <h4 id="input-schema-sql" class="top-code-caption"> <a href="#input-schema-sql" class="anchor-heading" aria-labelledby="input-schema-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-schema.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">product</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">price</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">sale</span><span class="p">(</span>
    <span class="n">id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">quantity</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">product_id</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-f</span> input-schema.sql salesDb
</code></pre></div></div> <p>Data Napkin is going to consume:</p> <h4 id="input-data-sql" class="top-code-caption"> <a href="#input-data-sql" class="anchor-heading" aria-labelledby="input-data-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-data.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">product</span> <span class="k">values</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="s1">'chocolate bar'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="s1">'coke'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="s1">'kale'</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">sale</span> <span class="k">values</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>    <span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>   <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-f</span> input-data.sql salesDb
</code></pre></div></div> <h3 id="napkin-queries"> <a href="#napkin-queries" class="anchor-heading" aria-labelledby="napkin-queries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Napkin Queries </h3> <p>Place sink tables in sql sub folder, they are going to be used for spec generation.</p> <h4 id="sql-best-seller-sql" class="top-code-caption"> <a href="#sql-best-seller-sql" class="anchor-heading" aria-labelledby="sql-best-seller-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-seller.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">sale</span>
 <span class="k">group</span> <span class="k">by</span> <span class="n">product_id</span>
 <span class="k">order</span> <span class="k">by</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div></div> <h4 id="sql-best-revenue-sql" class="top-code-caption"> <a href="#sql-best-revenue-sql" class="anchor-heading" aria-labelledby="sql-best-revenue-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-revenue.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">sale</span> <span class="n">s</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">product</span> <span class="n">p</span> <span class="k">on</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">group</span> <span class="k">by</span> <span class="n">product_id</span>
 <span class="k">order</span> <span class="k">by</span> <span class="mi">2</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div></div> <p>Create a spec out of queries above. It is easy to run these queries manually, but our goal now is to grasp Napkin basics, because Napkin knows correct order for executing such queries, which have dependencies between themselves.</p> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">napkin</span> <span class="n">generate</span><span class="o">-</span><span class="n">spec</span> <span class="o">-</span><span class="n">d</span> <span class="k">sql</span> <span class="o">-</span><span class="n">o</span> <span class="n">spec</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">mkdir</span> <span class="n">specs</span>
<span class="n">mv</span> <span class="k">sql</span> <span class="n">spec</span><span class="p">.</span><span class="n">yaml</span> <span class="n">specs</span>
</code></pre></div></div> <p>Have a look at head of spec.yaml:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">sql_folder</span><span class="pi">:</span> <span class="s">sql</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">postgres:///</span>
<span class="na">haskell_packages</span><span class="pi">:</span> <span class="pi">[]</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Postgres</span>
<span class="na">haskell</span><span class="pi">:</span> <span class="no">null</span>
<span class="na">tables</span><span class="pi">:</span>
</code></pre></div></div> <p>Correct <code class="language-plaintext highlighter-rouge">db_url</code>, for my local case I have:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">postgresql:/user:123@127.0.0.1/salesDb</span>
</code></pre></div></div> <div class="language-plaintext info highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Keepking passwords in a common configuration file is a bad idea.
You can provide password through `--connectionURL` command line option.
See `--help` for more details.
</code></pre></div></div> <p>Everything is ready for calling Napkin master command:</p> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NOTICE:  table "best-revenue" does not exist, skipping
NOTICE:  table "best-seller" does not exist, skipping
[2021-08-20 17:25:14] Table "best-revenue" ran in 0.03s: 3 rows affected
[2021-08-20 17:25:14] Table "best-seller" ran in 0.04s: 3 rows affected
[2021-08-20 17:25:14] Run complete. Total cost: 6 rows affected
</code></pre></div></div> <p>Check DB - a few new tables appeared (<code class="language-plaintext highlighter-rouge">best-seller</code>and <code class="language-plaintext highlighter-rouge">best-revenue</code>):</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span>  <span class="nv">"best-seller"</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> product_id | sum
------------+------
          1 | 1000
          2 |  300
          3 |   12
</code></pre></div></div> <p>Napkin created tables for your queries, evaluated them and persisted results.</p> <p>Let’s modify input data pushing on kale and rerun Napkin:</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">sale</span> <span class="k">values</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span>  <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"best-seller"</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> product_id | sum
------------+------
          3 | 1011
          1 | 1000
          2 |  300
</code></pre></div></div> <p>See <code class="language-plaintext highlighter-rouge">best-seller</code> is updated with kale on the top.</p> <p>We started with very simple schema - ids instead of numbers look ugly. How about to make sink tables more human readable?</p> <h4 id="sql-best-seller-sql-version-2" class="top-code-caption"> <a href="#sql-best-seller-sql-version-2" class="anchor-heading" aria-labelledby="sql-best-seller-sql-version-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-seller.sql version: 2 </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">price</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">sale</span> <span class="n">s</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">product</span> <span class="n">p</span> <span class="k">on</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">group</span> <span class="k">by</span> <span class="n">product_id</span>
 <span class="k">order</span> <span class="k">by</span> <span class="mi">3</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div></div> <p>Schema table is updated automatically:</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"best-seller"</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     name      | price | sum
---------------+-------+------
 kale          |     5 | 1011
 chocolate bar |     2 | 1000
 coke          |     3 |  300
</code></pre></div></div> <h2 id="mustache-template-and-variable-interpolation"> <a href="#mustache-template-and-variable-interpolation" class="anchor-heading" aria-labelledby="mustache-template-and-variable-interpolation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mustache template and variable interpolation </h2> <p>The next step in mastering Napking is mustache templates in queries.</p> <p>Templates give an opportunity to parameterize query and reuse it for multiple tables, but templates could make query even more dynamic with conditions and branches.</p> <p>Statistical models are full of parameteres and there is no deterministic criteria for picking good values for them.</p> <p>A parameterizied query helps with juggling mutliple variations of these parameters in a single DB in parallel and compare results row to row.</p> <p>Template variables can be set in a spec file or could be overriden globally with command line options. Template variable holds a text for substition variable name in a template query - template variable value is a free form text. A final query should be a valid SQL expression.</p> <p>There are 2 versions of stddev functions in Postgres. Let’s compare them by computing results in dedicated tables, but reusing a single parameterized query.</p> <h4 id="sql-stdev-mtpl" class="top-code-caption"> <a href="#sql-stdev-mtpl" class="anchor-heading" aria-labelledby="sql-stdev-mtpl"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/stdev.mtpl </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">.)</span>
  <span class="k">from</span>  <span class="n">s</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">product</span> <span class="n">p</span> <span class="k">on</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
 <span class="k">group</span> <span class="k">by</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

</code></pre></div></div> <p>Append following config to spec.yaml:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">stddev.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span><span class="s2">"</span><span class="s">column_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quantity"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">table_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">stddev"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">stddev_pop"</span><span class="pi">}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">sale_stddev_pop_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
<span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">stddev.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span><span class="s2">"</span><span class="s">column_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quantity"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">table_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">stddev"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">stddev_samp"</span><span class="pi">}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">sale_stddev_sam_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <p>Compare results:</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stddev_pop</span><span class="p">,</span> <span class="n">stddev_samp</span>
  <span class="k">from</span> <span class="n">sale_stddev_pop_quantity</span> <span class="n">p</span><span class="p">,</span> <span class="n">sale_stddev_sam_quantity</span> <span class="n">s</span>
 <span class="k">where</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     name      |    stddev_pop    |   stddev_samp
---------------+------------------+------------------
 coke          |                0 |
 kale          | 468.116082469580 | 573.322771220540
 chocolate bar |                0 |
</code></pre></div></div> <h2 id="chain-of-queries"> <a href="#chain-of-queries" class="anchor-heading" aria-labelledby="chain-of-queries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chain of queries </h2> <p>Prevous join query we run manually. Let’s make a sink table in a spec to observe how tables from a chain of dependent queries are updated.</p> <p>Append following config to spec.yaml:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">compare-sale-stddev-quantity.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">compare_sale_stddev_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div> <p>Truncate intermediate tables to prove correct execution order for depedent queries:</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">truncate</span> <span class="n">sale_stddev_pop_quantity</span><span class="p">;</span>
<span class="k">truncate</span> <span class="n">sale_stddev_sam_quantity</span><span class="p">;</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span>  <span class="n">compare_sale_stddev_quantity</span><span class="p">;</span>
</code></pre></div></div> <p>Sink table has been calculated last and got result:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     name      |    stddev_pop    |   stddev_samp
---------------+------------------+------------------
 coke          |                0 |
 kale          | 468.116082469580 | 573.322771220540
 chocolate bar |                0 |
</code></pre></div></div> <h2 id="sql-macro-functions"> <a href="#sql-macro-functions" class="anchor-heading" aria-labelledby="sql-macro-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SQL macro functions </h2> <h2 id="backends"> <a href="#backends" class="anchor-heading" aria-labelledby="backends"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Backends </h2> <p>Napkin supports following backends:</p> <ul> <li><a href="https://www.postgresql.org/">Postgres</a></li> <li><a href="https://cloud.google.com/bigquery">BigQuery</a></li> <li><a href="https://aws.amazon.com/redshift">Redshift</a></li> </ul> <p>Napkin backend is a some DB management systems with tables. There are dozens of popular DB managements systems, so tells us what system, as a Napkin backend, you would like to see next.</p> <h2 id="bigquery"> <a href="#bigquery" class="anchor-heading" aria-labelledby="bigquery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> BigQuery </h2> <p>OAuth authentication.</p> <h2 id="embedded-haskell"> <a href="#embedded-haskell" class="anchor-heading" aria-labelledby="embedded-haskell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Embedded Haskell </h2> <p>Lot’s of programs have embedded scripting langauge for better flexibility and automating complex business logic, recall - <a href="https://en.wikipedia.org/wiki/Visual_Basic_for_Applications">VBA</a>, <a href="https://en.wikipedia.org/wiki/Emacs_Lisp">Emacs Lisp</a>, <a href="https://en.wikipedia.org/wiki/Autodesk_3ds_Max">MaxScript</a>, etc and Napkin is on the same line with them and Napkin Api is available through <a href="https://en.wikipedia.org/wiki/Haskell_(programming_language)">Haskell</a>.</p> <h3 id="evaluation-haskell-through-eval"> <a href="#evaluation-haskell-through-eval" class="anchor-heading" aria-labelledby="evaluation-haskell-through-eval"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Evaluation Haskell through <strong>eval</strong> </h3> <p>Napkin eval command can interpret a set of free form Haskell modules - just specify top function you are intereseted in.</p> <p>Module with a lazy string function:</p> <div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">Hello</span> <span class="kr">where</span>
<span class="kr">import</span> <span class="nn">Prelude</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="p">(</span><span class="o">++</span><span class="p">),</span> <span class="kt">Char</span><span class="p">)</span>
<span class="n">pureStr</span> <span class="o">::</span> <span class="kt">String</span>
<span class="n">pureStr</span> <span class="o">=</span> <span class="s">"Hello World!!!"</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>napkin <span class="nb">eval</span> <span class="nt">-f</span> pureStr <span class="nt">-m</span> Hello  <span class="nt">-r</span> <span class="nb">.</span> <span class="nt">-i</span> Pure str
Hello World!!!
</code></pre></div></div> <p>See help for calling IO action.</p> <p>Access to plain Haskell interpeter is a test environment for code to be used in spec for describing tables.</p> </div> </div> <div class="search-overlay"></div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
