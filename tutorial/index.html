<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Tutorial - Napkin Wiki</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Tutorial | Napkin Wiki</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Tutorial" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Napkin Wiki with howtos and tutorials." /> <meta property="og:description" content="Napkin Wiki with howtos and tutorials." /> <link rel="canonical" href="https://soostone.github.io/tutorial/" /> <meta property="og:url" content="https://soostone.github.io/tutorial/" /> <meta property="og:site_name" content="Napkin Wiki" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Tutorial" /> <script type="application/ld+json"> {"headline":"Tutorial","dateModified":"2021-08-25T11:50:00+00:00","@type":"WebPage","url":"https://soostone.github.io/tutorial/","description":"Napkin Wiki with howtos and tutorials.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://soostone.github.io/assets/images/logo-and-name.svg"}},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://soostone.github.io/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <li class="nav-list-item"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="https://soostone.github.io/about/" class="nav-list-link">About</a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link">Getting Started</a> <ul><li> <a href="/getting-started/#installation" style="padding-left: 0.2rem;" class="nav-list-link"> Installation </a> </li><li> <a href="/getting-started/#hello-world" style="padding-left: 0.2rem;" class="nav-list-link"> Hello world </a> </li></ul></li><li class="nav-list-item active"><a href="https://soostone.github.io/tutorial/" class="nav-list-link active">Tutorial</a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/user-manual/" class="nav-list-link">User Manual</a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link">Haddock</a> <ul></ul></li></ul> </nav> <footer class="site-footer"> <span>Copyright &copy; 2020-2021 <a href="http://soostone.com/" class="black"> <img style="height: 13px; vertical-align: bottom; padding-left: 5px;" src="/assets/images/logo-gem-100.png" /> Soostone </a> </span> </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Napkin Wiki" aria-label="Search Napkin Wiki" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <ol id="markdown-toc"> <li><a href="#tutorial" id="markdown-toc-tutorial">Tutorial</a> <ol> <li><a href="#interacting-with-napkin---the-spec" id="markdown-toc-interacting-with-napkin---the-spec">Interacting with Napkin - The Spec</a></li> <li><a href="#sales-db-demo" id="markdown-toc-sales-db-demo">Sales DB demo</a> <ol> <li><a href="#starting-out---creating-your-napkin-spec-file" id="markdown-toc-starting-out---creating-your-napkin-spec-file">Starting out - Creating your Napkin Spec file</a></li> <li><a href="#schema-and-input-data" id="markdown-toc-schema-and-input-data">Schema and Input Data</a></li> <li><a href="#setting-up-the-pipeline" id="markdown-toc-setting-up-the-pipeline">Setting up The Pipeline</a></li> </ol> </li> <li><a href="#using-templates-and-variable-interpolation" id="markdown-toc-using-templates-and-variable-interpolation">Using Templates and Variable Interpolation</a></li> <li><a href="#chain-of-queries" id="markdown-toc-chain-of-queries">Chain of queries</a></li> <li><a href="#sql-macro-functions" id="markdown-toc-sql-macro-functions">SQL macro functions</a></li> <li><a href="#backends" id="markdown-toc-backends">Backends</a></li> <li><a href="#bigquery" id="markdown-toc-bigquery">BigQuery</a></li> <li><a href="#embedded-haskell" id="markdown-toc-embedded-haskell">Embedded Haskell</a> <ol> <li><a href="#evaluation-haskell-through-eval" id="markdown-toc-evaluation-haskell-through-eval">Evaluation Haskell through <strong>eval</strong></a></li> </ol> </li> <li><a href="#misc" id="markdown-toc-misc">Misc</a> <ol> <li><a href="#unused-column-detection" id="markdown-toc-unused-column-detection">Unused column detection</a></li> </ol> </li> </ol> </li> </ol> <h1 id="tutorial"> <a href="#tutorial" class="anchor-heading" aria-labelledby="tutorial"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tutorial </h1> <h2 id="interacting-with-napkin---the-spec"> <a href="#interacting-with-napkin---the-spec" class="anchor-heading" aria-labelledby="interacting-with-napkin---the-spec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Interacting with Napkin - The Spec </h2> <p>Napkin is a data pipeline automation tool, designed to execute a series of .sql queries where the resultant data is utilized to create downstream tables. The interface to specify what .sql files to execute is called a Napkin <strong>Spec</strong>. A Spec is defined via a configuration language called <a href="https://en.wikipedia.org/wiki/YAML">YAML</a>. This follows a common paradigm where source tables are never mutated. Instead, Napkin can be repeatably run to create a series of dependent tables as new data comes in to one or many source tables.</p> <p>The sql files / tables in the Napkin Spec comprise an implicit <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a>, where edges are references to fields from other tables.</p> <p>A common use case is as follows</p> <ul> <li>Source tables are created or updated manually via a data extract or automatically by a piece of software</li> <li>.SQL files are written to mutate the data into the desired shape that is fit for use in new, downstream tables (never modifying the source data)</li> <li>A Napkin Spec is created to execute these .SQL files automatically, repeatedly and in the correct dependency order</li> <li>As new data comes in, the Napkin Spec can be manually or automatically run to recreate the dependent tables with the new data for ongoing use</li> </ul> <h2 id="sales-db-demo"> <a href="#sales-db-demo" class="anchor-heading" aria-labelledby="sales-db-demo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sales DB demo </h2> <h3 id="starting-out---creating-your-napkin-spec-file"> <a href="#starting-out---creating-your-napkin-spec-file" class="anchor-heading" aria-labelledby="starting-out---creating-your-napkin-spec-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Starting out - Creating your Napkin Spec file </h3> <p>While you can write out a Napkin Spec file in .yaml yourself, Napkin also has built-in functionality to set this up for you and can help automatically generate the Spec file. All Napkin needs to do this is at least one SQL file.</p> <p>Let’s consider a sales DB with the following tables:</p> <h3 id="schema-and-input-data"> <a href="#schema-and-input-data" class="anchor-heading" aria-labelledby="schema-and-input-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Schema and Input Data </h3> <p>First, we’ll need to create a source dataset. As a reminder, our SQL pipeline will read from these tables to create the downstream tables but will never mutate the data directly in the source tables.</p> <h4 id="input-schema-sql" class="top-code-caption"> <a href="#input-schema-sql" class="anchor-heading" aria-labelledby="input-schema-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-schema.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">product</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">price</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sale</span><span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">quantity</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">product_id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-f</span> input-schema.sql salesDb
</code></pre></div></div> <p>Then we’ll put some data into them.</p> <h4 id="input-data-sql" class="top-code-caption"> <a href="#input-data-sql" class="anchor-heading" aria-labelledby="input-data-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-data.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">product</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="s1">'chocolate bar'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="s1">'coke'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="s1">'kale'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">sale</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>    <span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>   <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-f</span> input-data.sql salesDb
</code></pre></div></div> <h3 id="setting-up-the-pipeline"> <a href="#setting-up-the-pipeline" class="anchor-heading" aria-labelledby="setting-up-the-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up The Pipeline </h3> <p>Place the .sql files that will create your dependent tables in the /sql sub-folder so the Napkin Spec can see and execute them.</p> <p>Here are a couple examples of queries that can run against the source tables we just created.</p> <h4 id="sql-best-seller-sql" class="top-code-caption"> <a href="#sql-best-seller-sql" class="anchor-heading" aria-labelledby="sql-best-seller-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-seller.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">sale</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">product_id</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div> <h4 id="sql-best-revenue-sql" class="top-code-caption"> <a href="#sql-best-revenue-sql" class="anchor-heading" aria-labelledby="sql-best-revenue-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-revenue.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">sale</span> <span class="n">s</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="n">p</span> <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">product_id</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div> <p>Next, let’s have Napkin automatically generate the Spec file to execute the queries above. Note that Napkin can figure out the dependency relationship of the SQL files and execute them in the correct order.</p> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">napkin</span> <span class="n">generate</span><span class="o">-</span><span class="n">spec</span> <span class="o">-</span><span class="n">d</span> <span class="k">sql</span> <span class="o">-</span><span class="n">o</span> <span class="n">spec</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">mkdir</span> <span class="n">specs</span>
<span class="n">mv</span> <span class="k">sql</span> <span class="n">spec</span><span class="p">.</span><span class="n">yaml</span> <span class="n">specs</span>
</code></pre></div></div> <p>This is what the head of the spec.yaml might look like:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">sql_folder</span><span class="pi">:</span> <span class="s">sql</span>
<span class="na">db_url</span><span class="pi">:</span> <span class="s">postgres:///</span>
<span class="na">haskell_packages</span><span class="pi">:</span> <span class="pi">[]</span>
<span class="na">backend</span><span class="pi">:</span> <span class="s">Postgres</span>
<span class="na">haskell</span><span class="pi">:</span> <span class="no">null</span>
<span class="na">tables</span><span class="pi">:</span>
</code></pre></div></div> <p>For <code class="language-plaintext highlighter-rouge">db_url</code>, this is an example for configuring Napkin to run against a local PostgreSQL instance:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">db_url</span><span class="pi">:</span> <span class="s">postgresql:/user:123@127.0.0.1/salesDb</span>
</code></pre></div></div> <div class="language-plaintext info highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To avoid keepking passwords in a common configuration file, you can provide the database password through Napkin's `--connectionURL` command line option.
See `--help` for more details.
</code></pre></div></div> <p>Once you have the Spec, your source tables and the .sql files to execute, you’re all set! The next step is to tell Napkin to execute the pipieline you’ve created. This is done through the ‘run’ command as shown below.</p> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NOTICE:  table "best-revenue" does not exist, skipping
NOTICE:  table "best-seller" does not exist, skipping
[2021-08-20 17:25:14] Table "best-revenue" ran in 0.03s: 3 rows affected
[2021-08-20 17:25:14] Table "best-seller" ran in 0.04s: 3 rows affected
[2021-08-20 17:25:14] Run complete. Total cost: 6 rows affected
</code></pre></div></div> <p>Once the pipeline has run, you can check the database for the new tables (<code class="language-plaintext highlighter-rouge">best-seller</code>and <code class="language-plaintext highlighter-rouge">best-revenue</code>):</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span>  <span class="nv">"best-seller"</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> product_id | sum
------------+------
          1 | 1000
          2 |  300
          3 |   12
</code></pre></div></div> <p>Now you’re all set! You have a working SQL pipeline and as new data comes in to your source tables you can repeatably give napkin the ‘run’ command to execute the pipeline and recreate the target tables.</p> <p>As an example, let’s modify our input data here and rerun the pipeline.</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">sale</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span>  <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"best-seller"</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> product_id | sum
------------+------
          3 | 1011
          1 | 1000
          2 |  300
</code></pre></div></div> <p>As expected, the updated target tables reflect the change in source data and the <code class="language-plaintext highlighter-rouge">best-seller</code> table is updated with the new row with the value ‘kale’ in it on top.</p> <h2 id="using-templates-and-variable-interpolation"> <a href="#using-templates-and-variable-interpolation" class="anchor-heading" aria-labelledby="using-templates-and-variable-interpolation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Templates and Variable Interpolation </h2> <p>The next step in mastering Napkin is to utilize templates to parameterize your queries. This is an extremely important feature because it can be used for everything from handling different table or variable names in development vs production datasets or simply reusing the same query for multiple purposes.</p> <p>Template variables can be set in a Spec file or can be overridden globally with command line options. Template variables hold text to be used in substitution for the variable name in a template query. The final query should always be a valid SQL expression.</p> <p>Let’s work through an example.</p> <p>There are 2 versions of STDDEV functions in Postgres. Let’s compare them by computing the results in dedicated tables, but reusing a single parameterized query.</p> <h4 id="sql-stdev-mtpl" class="top-code-caption"> <a href="#sql-stdev-mtpl" class="anchor-heading" aria-labelledby="sql-stdev-mtpl"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/stdev.mtpl </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">.)</span>
  <span class="k">FROM</span>  <span class="n">s</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="n">p</span> <span class="k">ON</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

</code></pre></div></div> <p>Append the following config to spec.yaml:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">stddev.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span><span class="s2">"</span><span class="s">column_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quantity"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">table_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">stddev"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">stddev_pop"</span><span class="pi">}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">sale_stddev_pop_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
<span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">stddev.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{</span><span class="s2">"</span><span class="s">column_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quantity"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">table_name"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">stddev"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">stddev_samp"</span><span class="pi">}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">sale_stddev_sam_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <p>Compare the results:</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stddev_pop</span><span class="p">,</span> <span class="n">stddev_samp</span>
  <span class="k">FROM</span> <span class="n">sale_stddev_pop_quantity</span> <span class="n">p</span><span class="p">,</span> <span class="n">sale_stddev_sam_quantity</span> <span class="n">s</span>
 <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     name      |    stddev_pop    |   stddev_samp
---------------+------------------+------------------
 coke          |                0 |
 kale          | 468.116082469580 | 573.322771220540
 chocolate bar |                0 |
</code></pre></div></div> <p>Here we can see that Napkin was able to run the same sql file but in taking the configuration from the spec.yaml file, actually executed two different valid queries with different results placed into different target tables.</p> <h2 id="chain-of-queries"> <a href="#chain-of-queries" class="anchor-heading" aria-labelledby="chain-of-queries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chain of queries </h2> <p>In the previous example, we ran our join query manually. Let’s update our Spec so that it’s automatically executed.</p> <p>Append the following config to your spec.yaml:</p> <h4 id="spec-yaml" class="top-code-caption"> <a href="#spec-yaml" class="anchor-heading" aria-labelledby="spec-yaml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> spec.yaml </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">post_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">pre_hooks</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">update_strategy</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">create_action</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">hidden_deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">deps</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">compare-sale-stddev-quantity.sql</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sql_file</span>
    <span class="na">vars</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">target_type</span><span class="pi">:</span> <span class="s">table</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">compare_sale_stddev_quantity</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div> <p>Let’s truncate our intermediate tables so we’re 100% confident that the resultant dataset in the target tables was created with the pipelien run we’re about to do.</p> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">truncate</span> <span class="n">sale_stddev_pop_quantity</span><span class="p">;</span>
<span class="k">truncate</span> <span class="n">sale_stddev_sam_quantity</span><span class="p">;</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin run <span class="nt">--spec-file</span> specs/spec.yaml
</code></pre></div></div> <h4 id="psql-salesdb" class="top-code-caption"> <a href="#psql-salesdb" class="anchor-heading" aria-labelledby="psql-salesdb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> psql salesDb </h4> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span>  <span class="n">compare_sale_stddev_quantity</span><span class="p">;</span>
</code></pre></div></div> <p>As we can see, the target table correctly shows the desired result from our parameterized queries:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     name      |    stddev_pop    |   stddev_samp
---------------+------------------+------------------
 coke          |                0 |
 kale          | 468.116082469580 | 573.322771220540
 chocolate bar |                0 |
</code></pre></div></div> <h2 id="sql-macro-functions"> <a href="#sql-macro-functions" class="anchor-heading" aria-labelledby="sql-macro-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SQL macro functions </h2> <h2 id="backends"> <a href="#backends" class="anchor-heading" aria-labelledby="backends"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Backends </h2> <p>Napkin supports following backends:</p> <ul> <li><a href="https://www.postgresql.org/">Postgres</a></li> <li><a href="https://cloud.google.com/bigquery">BigQuery</a></li> <li><a href="https://aws.amazon.com/redshift">Redshift</a></li> </ul> <p>These are the databases we currently support. Let us know if your database of choice is not here and maybe we can add it to a future release!</p> <h2 id="bigquery"> <a href="#bigquery" class="anchor-heading" aria-labelledby="bigquery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> BigQuery </h2> <p>OAuth authentication.</p> <h2 id="embedded-haskell"> <a href="#embedded-haskell" class="anchor-heading" aria-labelledby="embedded-haskell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Embedded Haskell </h2> <p>Lot’s of programs have embedded scripting langauge for better flexibility and automating complex business logic, recall - <a href="https://en.wikipedia.org/wiki/Visual_Basic_for_Applications">VBA</a>, <a href="https://en.wikipedia.org/wiki/Emacs_Lisp">Emacs Lisp</a>, <a href="https://en.wikipedia.org/wiki/Autodesk_3ds_Max">MaxScript</a>, etc and Napkin is on the same line with them and Napkin Api is available through <a href="https://en.wikipedia.org/wiki/Haskell_(programming_language)">Haskell</a>.</p> <h3 id="evaluation-haskell-through-eval"> <a href="#evaluation-haskell-through-eval" class="anchor-heading" aria-labelledby="evaluation-haskell-through-eval"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Evaluation Haskell through <strong>eval</strong> </h3> <p>Napkin eval command can interpret a set of free form Haskell modules - just specify top function you are intereseted in.</p> <p>Module with a lazy string function:</p> <div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">Hello</span> <span class="kr">where</span>
<span class="kr">import</span> <span class="nn">Prelude</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="p">(</span><span class="o">++</span><span class="p">),</span> <span class="kt">Char</span><span class="p">)</span>
<span class="n">pureStr</span> <span class="o">::</span> <span class="kt">String</span>
<span class="n">pureStr</span> <span class="o">=</span> <span class="s">"Hello World!!!"</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>napkin <span class="nb">eval</span> <span class="nt">-f</span> pureStr <span class="nt">-m</span> Hello  <span class="nt">-r</span> <span class="nb">.</span> <span class="nt">-i</span> Pure str
Hello World!!!
</code></pre></div></div> <p>See help for calling IO action.</p> <p>Access to plain Haskell interpeter is a test environment for code to be used in spec for describing tables.</p> <h2 id="misc"> <a href="#misc" class="anchor-heading" aria-labelledby="misc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Misc </h2> <h3 id="unused-column-detection"> <a href="#unused-column-detection" class="anchor-heading" aria-labelledby="unused-column-detection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Unused column detection </h3> <p>Some table columns are introduced for debugging and development purpose, but as time goes an engineer can stop using them and completely forget, meanwhile such columns contribute into cost of running queries.</p> <p>Let’s check following query for unused columns in an intermediate CTE table:</p> <h4 id="sql-query-sql" class="top-code-caption"> <a href="#sql-query-sql" class="anchor-heading" aria-labelledby="sql-query-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/query.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">CTE</span> <span class="k">as</span> <span class="p">(</span><span class="k">select</span> <span class="n">f</span><span class="p">,</span> <span class="k">g</span> <span class="k">from</span> <span class="n">DbTable</span><span class="p">)</span> <span class="k">select</span> <span class="n">f</span> <span class="k">from</span> <span class="n">CTE</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin optimize
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Table: [query]
query, CTE "CTE" has unused columns ["g"]
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> <script type="text/javascript" src="/assets/js/copy.js"></script> </body> </html>
