<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="manifest" href="/manifest.json" /> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/touch-icon/logo-76.png" /> <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/touch-icon/logo-120.png" /> <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/touch-icon/logo-152.png" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/touch-icon/logo-180.png" /> <meta name="msapplication-square70x70logo" content="/assets/images/touch-icon/logo-70.png" /> <meta name="msapplication-square150x150logo" content="/assets/images/touch-icon/logo-150.png" /> <meta name="msapplication-square310x310logo" content="/assets/images/touch-icon/logo-310.png" /> <!-- keywords not used by google but other search engines might still use --> <meta name="keywords" content="Napkin, BigQuery, Postgres, SQL, BigData, Data Scientist, Data Engineer, Analytics" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Tutorial | docs</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Tutorial" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Tutorial a new Napkin user with examples showing all features and usecases." /> <meta property="og:description" content="Tutorial a new Napkin user with examples showing all features and usecases." /> <link rel="canonical" href="https://soostone.github.io/tutorial/" /> <meta property="og:url" content="https://soostone.github.io/tutorial/" /> <meta property="og:site_name" content="docs" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Tutorial" /> <script type="application/ld+json"> {"headline":"Tutorial","dateModified":"2021-08-25T11:50:00+00:00","url":"https://soostone.github.io/tutorial/","@type":"WebPage","description":"Tutorial a new Napkin user with examples showing all features and usecases.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://soostone.github.io/assets/images/logo-and-name.svg"}},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="site-super-header"> <div class="site-logo"></div> <a class="link-button active" href="#">Documentation</a> <a class="link-button" href="#">Community</a> <a class="link-button" href="#">Features</a> <a class="link-button" href="#">Use Cases</a> <span class="gradient-border"> <a class="link-button " href="#">Install</a> </span> </div> <div class="side-bar" style="display: none;"> <div class="site-header"> <a href="https://soostone.github.io/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <li class="nav-list-item" style="display: none;"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link"> About </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link"> Getting Started </a> <ul><li> <a href="/getting-started/#installation" class="nav-list-link"> Installation </a> </li><li> <a href="/getting-started/#key-features" class="nav-list-link"> Hello world </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link"> Tutorial </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link"> Tips and Tricks </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/docker/" class="nav-list-link"> Docker </a> <ul><li> <a href="/docker/#basic-usage" class="nav-list-link"> Basic usage </a> </li><li> <a href="/docker/#advanced-usage" class="nav-list-link"> Advanced usage </a> </li><li> <a href="/docker/#technical-details" class="nav-list-link"> Technical details </a> </li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="https://soostone.github.io/user-manual/" class="nav-list-link"> User Manual </a> <ul></ul><ul class="nav-list "><li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection" class="nav-list-link">Connecting to the database</a></li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link"> Haddock </a> <ul></ul></li></ul> </nav> </div> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search docs" aria-label="Search docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main" id="top"> <div class="side-bar"> <ul class="nav-list"> <li class="nav-list-item" style="display: none;"> <a class="nav-list-link" href="https://napkinweb.webflow.io/"> Napkin product </a> </li><li class="nav-list-item"><a href="https://soostone.github.io/" class="nav-list-link"> About </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/getting-started/" class="nav-list-link"> Getting Started </a> <ul><li> <a href="/getting-started/#installation" class="nav-list-link"> Installation </a> </li><li> <a href="/getting-started/#key-features" class="nav-list-link"> Hello world </a> </li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tutorial/" class="nav-list-link"> Tutorial </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/tips-and-tricks/" class="nav-list-link"> Tips and Tricks </a> <ul></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/docker/" class="nav-list-link"> Docker </a> <ul><li> <a href="/docker/#basic-usage" class="nav-list-link"> Basic usage </a> </li><li> <a href="/docker/#advanced-usage" class="nav-list-link"> Advanced usage </a> </li><li> <a href="/docker/#technical-details" class="nav-list-link"> Technical details </a> </li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="https://soostone.github.io/user-manual/" class="nav-list-link"> User Manual </a> <ul></ul><ul class="nav-list "><li class="nav-list-item "><a href="https://soostone.github.io/user-manual/db-connection" class="nav-list-link">Connecting to the database</a></li></ul></li><li class="nav-list-item"><a href="https://soostone.github.io/haddock/" class="nav-list-link"> Haddock </a> <ul></ul></li></ul> </div> <div class="main-content-lspander"></div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <ol id="markdown-toc"> <li><a href="#tutorial" id="markdown-toc-tutorial">Tutorial</a> <ol> <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li> <li><a href="#interacting-with-napkin---the-spec" id="markdown-toc-interacting-with-napkin---the-spec">Interacting with Napkin - The Spec</a></li> <li><a href="#create-a-minimal-napkin-project" id="markdown-toc-create-a-minimal-napkin-project">Create a minimal napkin project</a></li> <li><a href="#workflow" id="markdown-toc-workflow">Workflow</a> <ol> <li><a href="#source-tables-and-corresponding-data" id="markdown-toc-source-tables-and-corresponding-data">Source tables and corresponding data</a></li> <li><a href="#extending-napkin-spec" id="markdown-toc-extending-napkin-spec">Extending Napkin Spec</a></li> <li><a href="#processing-new-incoming-data" id="markdown-toc-processing-new-incoming-data">Processing new incoming data</a></li> </ol> </li> <li><a href="#using-templates-and-variable-interpolation" id="markdown-toc-using-templates-and-variable-interpolation">Using Templates and Variable Interpolation</a></li> <li><a href="#misc" id="markdown-toc-misc">Misc</a> <ol> <li><a href="#unused-column-detection" id="markdown-toc-unused-column-detection">Unused column detection</a></li> </ol> </li> <li><a href="#more-resources" id="markdown-toc-more-resources">More resources</a></li> <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li> </ol> </li> </ol> <h1 id="tutorial"> <a href="#tutorial" class="anchor-heading" aria-labelledby="tutorial"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tutorial </h1> <p>Napkin is a data pipeline automation tool, designed to execute a series of .sql queries where the resultant data is utilized to create downstream tables. Napkin currently supported backends are:</p> <ul> <li><a href="https://cloud.google.com/bigquery">BigQuery</a></li> <li><a href="https://aws.amazon.com/redshift">Redshift</a></li> <li><a href="https://www.postgresql.org/">Postgres</a></li> <li><a href="https://www.sqlite.org/index.html">SQLite</a></li> </ul> <p>In this hands-on tutorial we first use Napkin’s intuitive interface, <strong>Spec</strong>, to bootstrap and execute a simple SQL data pipeline. Next, we modify <code class="language-plaintext highlighter-rouge">Napkin Spec</code> to add additional computations to the data pipeline.</p> <h2 id="prerequisites"> <a href="#prerequisites" class="anchor-heading" aria-labelledby="prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h2> <ul> <li>Current installation <a href="https://soostone.github.io/getting-started/#installation">Napkin</a></li> <li>Access to <a href="https://www.postgresql.org/">PostgreSQL</a> instance</li> </ul> <h2 id="interacting-with-napkin---the-spec"> <a href="#interacting-with-napkin---the-spec" class="anchor-heading" aria-labelledby="interacting-with-napkin---the-spec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Interacting with Napkin - The Spec </h2> <p><strong>Spec</strong>, a high level <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> in <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> configuration language, is the interface to Napkin. In other words, Napkin Spec is simply a <code class="language-plaintext highlighter-rouge">yaml-file</code>. Napkin follows a common paradigm where source tables are never mutated. Instead, Napkin can continuously execute and create a series of dependent tables as new data comes into one or many source tables.</p> <p>The sql files / tables in the Napkin Spec comprise an implicit <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a>, where edges are references to fields from other tables.</p> <p>A common use case is as follows</p> <ul> <li>Source tables are created or updated manually via a data extract or automatically by a piece of software</li> <li>.SQL files are written to mutate the data into the desired shape that is fit for use in new, downstream tables (never modifying the source data)</li> <li>A Napkin Spec is created to execute these .SQL files automatically, repeatedly and in the correct dependency order</li> <li>As new data comes in, the Napkin Spec can be manually or automatically run to recreate the dependent tables with the new data for ongoing use</li> </ul> <p>In this tutorial, first, we utilize Napkin to author a SQL processing pipelines by:</p> <ul> <li>creating the necessary source tables and corresponding data</li> <li>bootstrapping a napkin project</li> <li>authoring and executing Napkin Spec</li> </ul> <p>We then make incremental enhancements to our SQL workflow and modify the Napkin Spec accordingly to execute the pipeline.</p> <h2 id="create-a-minimal-napkin-project"> <a href="#create-a-minimal-napkin-project" class="anchor-heading" aria-labelledby="create-a-minimal-napkin-project"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create a minimal napkin project </h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>napkin init <span class="nt">--project-name</span> sales-db
</code></pre></div></div> <p><em>Note: <code class="language-plaintext highlighter-rouge">napkin generate-spec</code> is capable of generating the Napkin Spec from existing SQL workflow. For the purpose of this tutorial, we opt out on this capability in favor of <code class="language-plaintext highlighter-rouge">napkin init</code> command. This will allow us to build the Napkin Spec incrementally while building our intuition on Napkin and Napkin workflow.</em></p> <p>The <code class="language-plaintext highlighter-rouge">napkin init</code> command creates a new Napkin project with the following directory structure:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Initialized empty Git repository <span class="k">in</span> /home/soostone/dev/napkin-projects/sales-db-2/tmp/napkin-dev/sales-db/.git/
➜  napkin-dev tree ./
./
└── sales-db
    ├── hie.yaml
    ├── README.md
    ├── specs
    │   └── spec.yaml
    └── sql
        └── example.sql

3 directories, 4 files
</code></pre></div></div> <p>Next, we execute our minimal Napkin Spec</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  napkin-dev <span class="nb">cd </span>sales-db
➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run <span class="nt">-spec-file</span> ./specs/spec.yaml
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2021-12-03 19:13:43][combo][Info][soostone-XPS-15-7590][PID 3511168][ThreadId 15][table:<span class="s2">"example"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-03 19:13:43][combo][Error][soostone-XPS-15-7590][PID 3511168][ThreadId 15][Error:NapkinEffectError_FatalError "libpq: failed (could not translate host name \"host\" to address: Temporary failure in name resolution\n)"][table:"example"] Table'</span>s action raised an error.
<span class="o">[</span>2021-12-03 19:13:43][combo][Info][soostone-XPS-15-7590][PID 3511168][ThreadId 4] Execution completed. Please see below <span class="k">for </span>a summary.
<span class="o">[</span>2021-12-03 19:13:43][combo][Info][soostone-XPS-15-7590][PID 3511168][ThreadId 4] <span class="nt">----------------------------------------------------------</span>
<span class="o">[</span>2021-12-03 19:13:43][combo][Error][soostone-XPS-15-7590][PID 3511168][ThreadId 4] Table <span class="s2">"example"</span> raised an error: libpq: failed <span class="o">(</span>could not translate host name <span class="s2">"host"</span> to address: Temporary failure <span class="k">in </span>name resolution
<span class="o">)</span>
<span class="o">[</span>2021-12-03 19:13:43][combo][Info][soostone-XPS-15-7590][PID 3511168][ThreadId 4] Run complete. Total cost:
</code></pre></div></div> <p>The expected error indicates that Napkin could not <strong>connect to the database</strong>. To resolve the error, we’ll modify the Napkin Spec, <code class="language-plaintext highlighter-rouge">specs/spec.yaml</code>, with the correct database connection <a href="https://www.postgresql.org/docs/8.1/ecpg-connect.html">URL</a>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db_url: postgresql://myUserId:myPassword@localhost/salesdb
</code></pre></div></div> <p>Next we Validate the spec file,</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin validate <span class="nt">--spec-file</span> ./specs/spec.yaml
OK
</code></pre></div></div> <p>And finally we are ready to execute our Napkin project:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run <span class="nt">--spec-file</span> ./specs/spec.yaml
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15][table:"example"] Executing table's action
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15] Command performed in 0.01.
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15] Command performed in 0.00.
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15] Command performed in 0.00.
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15][table:"example"] Table's action complete.
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 15] TableSpec "example" server stats: 50 rows affected
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 4] Execution completed. Please see below for a summary.
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 4] ----------------------------------------------------------
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 4] Table "example" ran in 0.02: 50 rows affected
[2021-12-03 19:41:57][combo][Info][soostone-XPS-15-7590][PID 3527014][ThreadId 4] Run complete. Total cost: 50 rows affected
</code></pre></div></div> <p><em>Assumption:</em> You have all required privileges to PostgreSQL database <code class="language-plaintext highlighter-rouge">sqldb</code></p> <h2 id="workflow"> <a href="#workflow" class="anchor-heading" aria-labelledby="workflow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Workflow </h2> <p>In this section we’ll extend our Napkin Spec to create a SQL data pipeline. This will require:</p> <ul> <li>create source tables</li> <li>create dependent queries to set up the data pipeline</li> <li>extend spec/spec.yaml to execute pipelines</li> </ul> <p>We start by creating the source tables first.</p> <p><em>Assumption:</em> The upcoming sections assume you have installed and configure <a href="https://www.postgresql.org/docs/13/runtime-config.html">psql</a></p> <h3 id="source-tables-and-corresponding-data"> <a href="#source-tables-and-corresponding-data" class="anchor-heading" aria-labelledby="source-tables-and-corresponding-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Source tables and corresponding data </h3> <p>Source tables are input to the Napkin SQL pipeline and are not mutated. Napkin utilizes them to create downstream tables. To create the source tables:</p> <h4 id="input-schema-sql" class="top-code-caption"> <a href="#input-schema-sql" class="anchor-heading" aria-labelledby="input-schema-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-schema.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">product</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">price</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sale</span><span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">quantity</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">product_id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ psql <span class="nt">-f</span> input-schema.sql salesDb
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE
CREATE TABLE
</code></pre></div></div> <p>Next, we add some data to the tables:</p> <h4 id="input-data-sql" class="top-code-caption"> <a href="#input-data-sql" class="anchor-heading" aria-labelledby="input-data-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> input-data.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">product</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="s1">'chocolate bar'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="s1">'coke'</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="s1">'kale'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">sale</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>    <span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>   <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <h4 id="shell" class="top-code-caption"> <a href="#shell" class="anchor-heading" aria-labelledby="shell"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> shell </h4> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ psql <span class="nt">-f</span> input-data.sql salesDb
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT 0 3
INSERT 0 4
</code></pre></div></div> <p>Then, we create the SQL query files, <code class="language-plaintext highlighter-rouge">./sql/best-seller.sql</code> and <code class="language-plaintext highlighter-rouge">./sql/best-revenue.sql</code> in the <code class="language-plaintext highlighter-rouge">./sql/</code> folder:</p> <h4 id="sql-best-seller-sql" class="top-code-caption"> <a href="#sql-best-seller-sql" class="anchor-heading" aria-labelledby="sql-best-seller-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-seller.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">sale</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">product_id</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div> <h4 id="sql-best-revenue-sql" class="top-code-caption copiable"> <a href="#sql-best-revenue-sql" class="anchor-heading" aria-labelledby="sql-best-revenue-sql"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sql/best-revenue.sql </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">product_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">quantity</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">sale</span> <span class="n">s</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="n">p</span> <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">product_id</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div> <p>Our project directory structure should resemble:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ tree <span class="nb">.</span>
<span class="nb">.</span>
├── data
│   └── napkin.v2.sqlite3
├── hie.yaml
├── README.md
├── specs
│   └── spec.yaml
└── sql
    ├── best-revenue.sql
    ├── best-seller.sql
    └── example.sql

</code></pre></div></div> <p>We are now ready to extend Napkin Spec to create our SQL data pipelines.</p> <h3 id="extending-napkin-spec"> <a href="#extending-napkin-spec" class="anchor-heading" aria-labelledby="extending-napkin-spec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Extending Napkin Spec </h3> <p>To extend Napkin for executing the pipeline, we’ll modify <code class="language-plaintext highlighter-rouge">./specs/spec.yaml</code> from:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># yaml-language-server: $schema=https://soostone-napkin-public.s3.us-east-1.amazonaws.com/schema/schema.json</span>

<span class="c"># Connect to databate:</span>
backend: Postgres
db_url: postgresql://myUserName:myPassword@localhost/salesdb
<span class="c"># set your password by providing it using --uri or set PGPASSWORD variable</span>

<span class="c"># backend: BigQuery</span>
<span class="c"># db_url: bigquery://google/project_name?dataset=default_dataset_name</span>
<span class="c"># Run `napkin auth` to obtain authentication token</span>

tables:
  example:
    create_action:
      <span class="nb">type</span>: sql_file
      <span class="nb">source</span>: example.sql
</code></pre></div></div> <p>to:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># yaml-language-server: $schema=https://soostone-napkin-public.s3.us-east-1.amazonaws.com/schema/schema.json</span>

<span class="c"># Connect to databate:</span>
backend: Postgres
db_url: postgresql://myUserName:myPassword@localhost/salesdb
<span class="c"># set your password by providing it using --uri or set PGPASSWORD variable</span>

sql_folder: ../sql

tables:
  best-seller:
    create_action:
      <span class="nb">type</span>: sql_file
      <span class="nb">source</span>: best-seller.sql
  best-revenue:
    create_action:
      <span class="nb">type</span>: sql_file
      <span class="nb">source</span>: best-revenue.sql
</code></pre></div></div> <p>We then <code class="language-plaintext highlighter-rouge">validate</code> the Spec to make sure we didn’t make any mistakes:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin validate <span class="nt">--spec-file</span> ./specs/spec.yaml
OK

</code></pre></div></div> <p>Next we execute the Spec, and hence the SQL pipeline:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run <span class="nt">--spec-file</span> ./specs/spec.yaml

<span class="sb">```</span>sh
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17][table:<span class="s2">"best-revenue"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18][table:"best-seller"] Executing table'</span>s action
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17] Command performed <span class="k">in </span>0.02.
NOTICE:  table <span class="s2">"best-revenue"</span> does not exist, skipping
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17][table:<span class="s2">"best-revenue"</span><span class="o">]</span> Table<span class="s1">'s action complete.
[2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18] Command performed in 0.01.
NOTICE:  table "best-seller" does not exist, skipping
[2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18] Command performed in 0.00.
[2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18] Command performed in 0.00.
[2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18][table:"best-seller"] Table'</span>s action complete.
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 17] TableSpec <span class="s2">"best-revenue"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 18] TableSpec <span class="s2">"best-seller"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 4] Execution completed. Please see below <span class="k">for </span>a summary.
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 4] <span class="nt">----------------------------------------------------------</span>
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 4] Table <span class="s2">"best-revenue"</span> ran <span class="k">in </span>0.03: 3 rows affected
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 4] Table <span class="s2">"best-seller"</span> ran <span class="k">in </span>0.02: 3 rows affected
<span class="o">[</span>2021-12-03 22:23:57][combo][Info][soostone-XPS-15-7590][PID 3604842][ThreadId 4] Run complete. Total cost: 6 rows affected

</code></pre></div></div> <p>And finally we verify the pipeline results:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'select * from "best-seller";'</span> | psql
 product_id | <span class="nb">sum</span>
<span class="nt">------------</span>+------
          1 | 1000
          2 |  300
          3 |   12
<span class="o">(</span>3 rows<span class="o">)</span>

  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'select * from "best-revenue";'</span> | psql
 product_id | <span class="nb">sum</span>
<span class="nt">------------</span>+------
          1 | 2000
          2 |  900
          3 |  600
<span class="o">(</span>3 rows<span class="o">)</span>

</code></pre></div></div> <p>Now we’re all set! We have a working SQL pipeline.</p> <p>In the next section, we’ll do a quick walk thru of how Napkin processes new ingested data</p> <h3 id="processing-new-incoming-data"> <a href="#processing-new-incoming-data" class="anchor-heading" aria-labelledby="processing-new-incoming-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Processing new incoming data </h3> <p>As we ingest incoming data into the source tables, we will continuously execute the Napkin <code class="language-plaintext highlighter-rouge">run</code> command to recreate the target tables. Let’s quickly demonstrate this capability by:</p> <ul> <li>insert some new data in our source table, data ingestion:</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'INSERT INTO sale VALUES (5, 999,  3);'</span> | psql

INSERT 0 1
</code></pre></div></div> <ul> <li>execute the Napkin pipeline:</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run <span class="nt">--spec-file</span> ./specs/spec.yaml
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17][table:<span class="s2">"best-revenue"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18][table:"best-seller"] Executing table'</span>s action
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17] Command performed <span class="k">in </span>0.01.
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17][table:<span class="s2">"best-revenue"</span><span class="o">]</span> Table<span class="s1">'s action complete.
[2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18] Command performed in 0.01.
[2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18] Command performed in 0.00.
[2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18] Command performed in 0.00.
[2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18][table:"best-seller"] Table'</span>s action complete.
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 17] TableSpec <span class="s2">"best-revenue"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 18] TableSpec <span class="s2">"best-seller"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 4] Execution completed. Please see below <span class="k">for </span>a summary.
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 4] <span class="nt">----------------------------------------------------------</span>
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 4] Table <span class="s2">"best-revenue"</span> ran <span class="k">in </span>0.01: 3 rows affected
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 4] Table <span class="s2">"best-seller"</span> ran <span class="k">in </span>0.01: 3 rows affected
<span class="o">[</span>2021-12-03 23:38:30][combo][Info][soostone-XPS-15-7590][PID 3644391][ThreadId 4] Run complete. Total cost: 6 rows affected

</code></pre></div></div> <ul> <li>verification of pipeline execution: <ul> <li>napkin <code class="language-plaintext highlighter-rouge">history</code> command :</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin <span class="nb">history </span>show <span class="nt">-s</span> ./specs/spec.yaml
</code></pre></div> </div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Table best-seller started at 2021-12-03 23:38:30 and finished at 2021-12-03 23:38:30 successfully affecting 3 rows
  Table best-revenue started at 2021-12-03 23:38:30 and finished at 2021-12-03 23:38:30 successfully affecting 3 rows
</code></pre></div> </div> <ul> <li>SQL:</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'SELECT * FROM "best-seller";'</span> | psql
</code></pre></div> </div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  product_id | <span class="nb">sum</span>
  <span class="nt">------------</span>+------
            3 | 1011
            1 | 1000
            2 |  300
  <span class="o">(</span>3 rows<span class="o">)</span>
</code></pre></div> </div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'SELECT * FROM "best-revenue";'</span> | psql

  product_id |  <span class="nb">sum</span>
  <span class="nt">------------</span>+-------
            3 | 50550
            1 |  2000
            2 |   900
  <span class="o">(</span>3 rows<span class="o">)</span>
</code></pre></div> </div> </li> </ul> <p>As expected, the updated target tables reflect the change in source data and the <code class="language-plaintext highlighter-rouge">best-seller</code> table is updated with the new row with the value ‘kale’ in it on top.</p> <p>Thus far, we’ve managed to create and execute a Napkin SQL data pipeline. We also showed how our pipeline may continuously execute to accommodate newly ingested data. In the next we touch on Napkin templates and template variable interpolation capabilities.</p> <h2 id="using-templates-and-variable-interpolation"> <a href="#using-templates-and-variable-interpolation" class="anchor-heading" aria-labelledby="using-templates-and-variable-interpolation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Templates and Variable Interpolation </h2> <p>The next step in extending Napkin Spec is to utilize templates to parameterize our queries. This is an extremely important feature because it can be used for everything from handling different table or variable names in development vs production datasets or simply reusing the same query for multiple purposes.</p> <p>Template variables may be set in a Spec file or may be overridden globally with command line options. Template variables hold text to be used in substitution for the variable name in a template query. The final query should always be a valid SQL expression.</p> <p>Let’s work through an example. There are 2 versions of <a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-STATISTICS-TABLE">STDDEV</a> functions in Postgres. Let’s compare them by computing the results in dedicated tables, but reusing a single parameterized query. to this:</p> <ul> <li>create the new query for the resulting table</li> <li>create the new parameterized STDDEV query</li> <li>update Napkin Spec, <code class="language-plaintext highlighter-rouge">spec/spec.yaml</code>, for the new queries</li> <li>validate Napkin Spec</li> <li>napkin <code class="language-plaintext highlighter-rouge">--dry-run</code>, this will give us the Napkin recipe for satisfying the pipeline execution</li> <li>execute Napkin Spec</li> </ul> <p><strong>First</strong> we create the required queries in <code class="language-plaintext highlighter-rouge">./sql/</code> folder as such:</p> <p><code class="language-plaintext highlighter-rouge">sql/stddev.sql</code></p> <h4 class="top-code-caption"> </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="err">{{</span><span class="n">stddev</span><span class="err">}}</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="err">{{</span><span class="k">column_name</span><span class="err">}}</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="err">{{</span><span class="k">table_name</span><span class="err">}}</span> <span class="n">s</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="n">p</span> <span class="k">ON</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">sql/compare-sale-stddev-quantity.sql</code></p> <h4 class="top-code-caption"> </h4> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stddev_pop</span><span class="p">,</span> <span class="n">stddev_samp</span>
  <span class="k">FROM</span> <span class="n">sale_stddev_pop_quantity</span> <span class="n">p</span><span class="p">,</span> <span class="n">sale_stddev_sam_quantity</span> <span class="n">s</span>
 <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div></div> <p><strong>Second</strong> we modify the Napkin Spec, specs/spec.yaml</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># yaml-language-server: $schema=https://soostone-napkin-public.s3.us-east-1.amazonaws.com/schema/schema.json</span>

<span class="c"># Connect to database:</span>
backend: Postgres
db_url: postgresql://myUserName:myPassword@localhost/salesdb
<span class="c"># set your password by providing it using --uri or set PGPASSWORD variable</span>

<span class="c"># backend: BigQuery</span>
<span class="c"># db_url: bigquery://google/project_name?dataset=default_dataset_name</span>
<span class="c"># Run `napkin auth` to obtain authentication token</span>

sql_folder: ../sql

tables:
  best-seller:
    create_action:
      <span class="nb">type</span>: sql_file
      <span class="nb">source</span>: best-seller.sql

  best-revenue:
    create_action:
      <span class="nb">type</span>: sql_file
      <span class="nb">source</span>: best-revenue.sql

  sale_stddev_sam_quantity:
    create_action:
      <span class="nb">source</span>: stddev.sql
      <span class="nb">type</span>: sql_file
      vars:
        <span class="o">{</span>
          <span class="s2">"column_name"</span>: <span class="s2">"quantity"</span>,
          <span class="s2">"table_name"</span>: <span class="s2">"sale"</span>,
          <span class="s2">"stddev"</span>: <span class="s2">"stddev_pop"</span>,
        <span class="o">}</span>
      target_type: table

  compare_sale_stddev_quantity:
    create_action:
      <span class="nb">source</span>: compare-sale-stddev-quantity.sql
      <span class="nb">type</span>: sql_file
      target_type: table

  sale_stddev_pop_quantity:
    create_action:
      <span class="nb">source</span>: stddev.sql
      <span class="nb">type</span>: sql_file
      vars:
        <span class="o">{</span>
          <span class="s2">"column_name"</span>: <span class="s2">"quantity"</span>,
          <span class="s2">"table_name"</span>: <span class="s2">"sale"</span>,
          <span class="s2">"stddev"</span>: <span class="s2">"stddev_samp"</span>,
        <span class="o">}</span>
      target_type: table

</code></pre></div></div> <p><strong>Third</strong> we validate the Napkin Spec:</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin validate <span class="nt">--spec-file</span> ./specs/spec.yaml
OK

</code></pre></div></div> <p><strong>Next</strong> we Napkin <code class="language-plaintext highlighter-rouge">run --dry-run</code> sub-command. Note that this is an informative command and doesn’t change the database state.</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run  <span class="nt">--spec-file</span> ./specs/spec.yaml <span class="nt">--dry-run</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 26][table:<span class="s2">"sale_stddev_pop_quantity"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 27][table:"sale_stddev_sam_quantity"] Executing table'</span>s action
<span class="o">[</span>2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 24][table:<span class="s2">"best-seller"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 23][table:"best-revenue"] Executing table'</span>s action
<span class="o">[</span>2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 25][table:<span class="s2">"compare_sale_stddev_quantity"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Execution completed. Please see below for a summary.
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] ----------------------------------------------------------
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Table "best-revenue" ran in 0.00:
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Table "best-seller" ran in 0.00:
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Table "compare_sale_stddev_quantity" ran in 0.00:
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Table "sale_stddev_pop_quantity" ran in 0.00:
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Table "sale_stddev_sam_quantity" ran in 0.00:
[2021-12-04 01:55:49][combo][Info][soostone-XPS-15-7590][PID 3718175][ThreadId 4] Run complete. Total cost:

</span></code></pre></div></div> <p><strong>And finally</strong> we execute the Napkin Spec</p> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin run  <span class="nt">--spec-file</span> ./specs/spec.yaml
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27][table:<span class="s2">"sale_stddev_sam_quantity"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24][table:"best-seller"] Executing table'</span>s action
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23][table:<span class="s2">"best-revenue"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26][table:"sale_stddev_pop_quantity"] Executing table'</span>s action
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24] Command performed <span class="k">in </span>0.02.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23] Command performed <span class="k">in </span>0.02.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24][table:<span class="s2">"best-seller"</span><span class="o">]</span> Table<span class="s1">'s action complete.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23] Command performed in 0.00.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23][table:"best-revenue"] Table'</span>s action complete.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26] Command performed <span class="k">in </span>0.02.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27] Command performed <span class="k">in </span>0.03.
NOTICE:  table <span class="s2">"sale_stddev_pop_quantity"</span> does not exist, skipping
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26] Command performed <span class="k">in </span>0.00.
NOTICE:  table <span class="s2">"sale_stddev_sam_quantity"</span> does not exist, skipping
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27] Command performed <span class="k">in </span>0.00.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 24] TableSpec <span class="s2">"best-seller"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26] Command performed <span class="k">in </span>0.01.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26][table:<span class="s2">"sale_stddev_pop_quantity"</span><span class="o">]</span> Table<span class="s1">'s action complete.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 23] TableSpec "best-revenue" server stats: 3 rows affected
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27] Command performed in 0.01.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27][table:"sale_stddev_sam_quantity"] Table'</span>s action complete.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 26] TableSpec <span class="s2">"sale_stddev_pop_quantity"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 27] TableSpec <span class="s2">"sale_stddev_sam_quantity"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25][table:<span class="s2">"compare_sale_stddev_quantity"</span><span class="o">]</span> Executing table<span class="s1">'s action
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25] Command performed in 0.01.
NOTICE:  table "compare_sale_stddev_quantity" does not exist, skipping
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25] Command performed in 0.00.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25] Command performed in 0.00.
[2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25][table:"compare_sale_stddev_quantity"] Table'</span>s action complete.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 25] TableSpec <span class="s2">"compare_sale_stddev_quantity"</span> server stats: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Execution completed. Please see below <span class="k">for </span>a summary.
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] <span class="nt">----------------------------------------------------------</span>
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Table <span class="s2">"best-revenue"</span> ran <span class="k">in </span>0.03: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Table <span class="s2">"best-seller"</span> ran <span class="k">in </span>0.02: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Table <span class="s2">"compare_sale_stddev_quantity"</span> ran <span class="k">in </span>0.01: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Table <span class="s2">"sale_stddev_pop_quantity"</span> ran <span class="k">in </span>0.03: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Table <span class="s2">"sale_stddev_sam_quantity"</span> ran <span class="k">in </span>0.06: 3 rows affected
<span class="o">[</span>2021-12-04 02:06:16][combo][Info][soostone-XPS-15-7590][PID 3724249][ThreadId 4] Run complete. Total cost: 15 rows affected

</code></pre></div></div> <p><strong>verifying the results</strong> :</p> <p>note the newly created tables:</p> <ul> <li><code class="language-plaintext highlighter-rouge">sale_stddev_pop_quantity</code></li> <li><code class="language-plaintext highlighter-rouge">sale_stddev_sam_quantity</code></li> <li><code class="language-plaintext highlighter-rouge">compare_sale_stddev_quantity</code></li> </ul> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">salesdb</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">best</span><span class="o">-</span><span class="n">revenue</span>                 <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">best</span><span class="o">-</span><span class="n">seller</span>                  <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">compare_sale_stddev_quantity</span> <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">example</span>                      <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">product</span>                      <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">sale</span>                         <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">sale_stddev_pop_quantity</span>     <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">sale_stddev_sam_quantity</span>     <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">soostone</span>

</code></pre></div></div> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ <span class="nb">echo</span> <span class="s1">'select * from "compare_sale_stddev_quantity"'</span> | psql
</code></pre></div></div> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="n">name</span>      <span class="o">|</span>    <span class="n">stddev_pop</span>    <span class="o">|</span>   <span class="n">stddev_samp</span>
<span class="c1">---------------+------------------+------------------</span>
 <span class="n">coke</span>          <span class="o">|</span>                <span class="mi">0</span> <span class="o">|</span>
 <span class="n">kale</span>          <span class="o">|</span> <span class="mi">468</span><span class="p">.</span><span class="mi">116082469580</span> <span class="o">|</span> <span class="mi">573</span><span class="p">.</span><span class="mi">322771220540</span>
 <span class="n">chocolate</span> <span class="n">bar</span> <span class="o">|</span>                <span class="mi">0</span> <span class="o">|</span>
<span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span>
</code></pre></div></div> <h2 id="misc"> <a href="#misc" class="anchor-heading" aria-labelledby="misc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Misc </h2> <h3 id="unused-column-detection"> <a href="#unused-column-detection" class="anchor-heading" aria-labelledby="unused-column-detection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Unused column detection </h3> <p>Some table columns are introduced for debugging and development purposes. As time goes an engineer may stop using them and loose track of their existence. Meanwhile such columns continue to recruit cost and complexity. Napkin optimize command can address such use-cases. Here is an example:</p> <ul> <li>create the CTE SQL file: <code class="language-plaintext highlighter-rouge">./sql/cte-query.sql</code></li> </ul> <div class="language-sql copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">CTE</span> <span class="k">as</span> <span class="p">(</span><span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span> <span class="k">from</span> <span class="n">product</span><span class="p">)</span> <span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">CTE</span><span class="p">;</span>
</code></pre></div></div> <ul> <li>append the following YAML snippet to the end of the <code class="language-plaintext highlighter-rouge">spec/specs.yaml</code></li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  cte-query-table:
    create_action:
      <span class="nb">source</span>: cte-query.sql
      <span class="nb">type</span>: sql_file
      target_type: table
</code></pre></div></div> <ul> <li>execute the <code class="language-plaintext highlighter-rouge">napkin optimize</code> command</li> </ul> <div class="language-sh copiable highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  sales-db git:<span class="o">(</span>main<span class="o">)</span> ✗ napkin optimize <span class="nt">--spec-file</span> ./specs/spec.yaml
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> unused column CTE.g
</code></pre></div></div> <h2 id="more-resources"> <a href="#more-resources" class="anchor-heading" aria-labelledby="more-resources"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> More resources </h2> <p>The following resources are available for learning more about Napkin:</p> <ul> <li><code class="language-plaintext highlighter-rouge">napkin --help</code></li> <li><code class="language-plaintext highlighter-rouge">napkin version</code> much more info about internal operations (useful for bug reports)</li> <li><a href="https://soostone.github.io/">napkin user’s guild</a></li> <li>slack napkin channel</li> </ul> <h2 id="conclusion"> <a href="#conclusion" class="anchor-heading" aria-labelledby="conclusion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conclusion </h2> <p>The purpose of this tutorial was to get you started with Napkin quickly. Consequently, we opted out on more advanced features of Napkin to keep the tutorial simple. We strongly recommend using Napkin <a href="https://en.wikipedia.org/wiki/Command-line_interface">CLI</a> help facility, <code class="language-plaintext highlighter-rouge">napkin --help</code> to get an intuition for some of the more advanced features of Napkin.</p> </div> </div> <div class="main-content-rspander"></div> <div class="search-overlay"></div> </div> <footer class="site-footer"> <div class="site-footer-lspandex"></div> <div class="site-footer-rows"> <div class="site-footer-r1"> <div class="logo white-napkin"></div> <div class="link-table"> <a href="#" class="">Documenation</a> <a href="#" class="">Community</a> <a href="#" class="">Features</a> </div> <div class="link-table"> <a href="#" class="">Use Cases</a> <a href="#" class="">About Napkin</a> <a href="#" class="">Contact</a> </div> <div class="gradient-border"> <a href="#" class="link-button">Get Napkin</a> </div> </div> <div class="media-bar"> <span class="media-pad"> <a href="#" class="logo fb-logo"></a> </span> <span class="media-pad"> <a href="#" class="logo linked-in-logo"></a> </span> <span class="media-pad"> <a href="#" class="logo twitter-logo"></a> </span> </div> <div class="site-footer-copy-right"> <div class="copyright"> Copyright 2021 &copy; &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; <a href="#">Privacy Policy</a> </div> <div class="made-with"> Made with <span class="gradient-text heart">&#x2764;</span> in NYC </div> </div> </div> <div class="site-footer-rspandex"></div> </footer> <script type="text/javascript" src="/assets/js/copy.js"></script> <script type="text/javascript" src="/assets/js/highlight-active-link.js"></script> </body> </html>
